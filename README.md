# Japan Overlay Map

日本の各種地理データをオーバーレイ表示できる汎用地図ライブラリです。

## 機能

### ベースマップ
- 標準（OpenStreetMap）
- 地理院地図
- 淡色地図
- 航空写真

### オーバーレイレイヤー

#### 気象情報
- 雨雲レーダー（リアルタイム・5分ごと自動更新）
- RainViewer API連携

#### 人口集中地区（DID）
- 全47都道府県のDIDデータを表示
- 地域別グループ化
- 透明度調整
- ホバー時のポップアップ情報（人口、面積、人口密度、市区町村コード）
- 一括表示/非表示切り替え
- **スマート検索機能**：市区町村を検索して地図を自動ズーム
  - 初期ロードは関東・近畿・中部の3地域のみ（高速化）
  - 検索結果がない場合、自動的にすべての都道府県をロード
  - 全国どの市区町村でも検索可能（例：「名護市」「神戸市」など）

#### 地理情報
- 陰影起伏図
- 色別標高図
- 傾斜量図

## セットアップ

```bash
npm install
npm run dev
```

ブラウザで http://localhost:5173 を開きます。

## ビルド

```bash
npm run build
```

## 技術スタック

- React 18
- TypeScript
- MapLibre GL JS
- Vite
- Storybook 8

## 地図について

### 地図タイルの種類

このアプリケーションは複数の地図タイルプロバイダーに対応しています：

| 地図 | プロバイダ | 特徴 |
|------|-----------|------|
| **標準** | OpenStreetMap (OSM) | カラフルで詳細。世界中で利用可能 |
| **地理院地図** | 国土地理院 (GSI) | 日本の公式地理データ。最も正確 |
| **淡色地図** | 国土地理院 (GSI) | シンプルで見やすい。背景データとして最適 |
| **航空写真** | 国土地理院 (GSI) | 衛星画像。地形や施設の確認に有用 |
| **メルカトル図法** | 国土地理院 (GSI) | 明示的にメルカトル投影を指定 |

### 地図投影法（地図図法）

#### メルカトル図法とは

メルカトル図法は、球体の地球を平面の紙に表現する方法です。

**特徴：**
- ✅ **直線が直線のまま** - 航海や航空ナビゲーションに便利
- ✅ **角度が正確** - 方角の表示が正確
- ❌ **高緯度ほど拡大される** - グリーンランドが実際より大きく見える
- ❌ **面積が歪む** - 赤道付近が小さく、極に近いほど大きく見える

**具体例：**
```
実際の大きさ    メルカトル図法での見え方
グリーンランド  ◻       グリーンランド  ◼◼◼  (実際より大きい)
日本          ◻       日本          ◻
オーストラリア ◼       オーストラリア ◻    (実際より小さい)
```

**なぜこのアプリで使用？**
- 🗺️ Google Maps、Apple Maps、OpenStreetMap など、**世界中のWebサービスがメルカトル図法を採用**
- 📱 スマートフォンの地図アプリも同じ
- 🌍 Web地図の業界標準
- 🎯 ラスタータイル（画像タイル）はメルカトル投影用に最適化されている

### 座標系

このアプリケーションで使用する座標系：

| 座標系 | 説明 |
|--------|------|
| **WGS84** (EPSG:4326) | 全地球測位システム (GPS) で使用。緯度経度で位置を表現 |
| **Web Mercator** | Webアプリケーション用のメルカトル投影。ズーム可能な地図用 |

**例：** 東京駅
```
緯度経度 (WGS84)      : 35.6762° N, 139.7674° E
```

## 気象情報とオーバーレイ

本アプリケーションは複数の気象・地理データソースを統合しています。

### 実装済みのAPI

| レイヤー | データソース | APIキー | 状態 |
|---------|-----------|--------|------|
| **雨雲レーダー** | [RainViewer API](https://www.rainviewer.com/api.html) | 不要 | ✅ 本番運用可能 |
| 気象情報（風・気圧等） | [OpenWeatherMap](https://openweathermap.org/api) | 必須 | ⚠️ 構造実装済み |

#### 雨雲レーダー (RainViewer API)
- **エンドポイント**: `https://api.rainviewer.com/public/weather-maps.json`
- **更新頻度**: 5分ごと自動更新
- **データ**: 過去のレーダーデータと降水予報（nowcast）
- **APIキー**: 不要（無料サービス）
- **フォールバック**: API失敗時は `(見本)` マーク付きモックを表示
- **実装**: `src/lib/services/rainViewer.ts`

#### OpenWeatherMap API
- **機能**: 風向・風速、気圧、降水量、視界情報
- **APIキー**: 必須（別途取得が必要）
- **実装**: `src/lib/services/openWeather.ts`

### モック表示機能

デモンストレーション用のモックデータを使用:
- **建物（地物）**: `util/geo.ts`で生成
- **LTEカバレッジ**: ローカルモック
- **風向・風速**: APIキー未設定時にモック表示

詳細は [NEXT_ACTION.md](./docs/NEXT_ACTION.md) のAPI仕様セクションを参照。

## 検索機能の使い方

### スマート検索（自動ロード）

左パネルの検索フォームで市区町村名を入力すると、自動的に地図がズームします。

```
例：
- 「栃木」と入力 → 栃木県のすべての市区町村が表示
- 「名護」と入力 → 沖縄県名護市が表示（未ロード層は自動ロード）
- 「奈良」と入力 → 奈良県のすべての市区町村が表示
```

### 検索の仕組み

1. **初期ロード**：アプリ起動時に関東・近畿・中部の3地域のデータをロード（高速化）
2. **検索実行**：ユーザーが市区町村名を入力すると即座に検索
3. **スマート自動ロード**：検索結果がない場合、自動的にすべての都道府県をロード
4. **再検索**：ロード完了後、自動的に検索を再実行

このアプローチにより：
- 初期ロード時間が短い（必要なデータだけ先読み）
- 全国どこの市区町村でも検索可能
- ユーザーは層の手動選択不要

### 検索可能なデータ

- **市区町村名**: 「東京」「大阪」「福岡」など
- **区（特別区）**: 「中央区」「渋谷区」など
- **市町村**: 「名古屋市」「京都市」など
- **町村**: 「南風原町」「読谷村」など

※データは2010年国勢調査ベースのため、その後の市町村合併は反映されていない場合があります。

## 操作方法

### キーボードショートカット

| キー | 機能 |
|------|------|
| `D` | DID（人口集中地区）表示切替 |
| `A` | 空港周辺空域表示切替 |
| `R` | レッドゾーン（飛行禁止区域）表示切替 |
| `Y` | イエローゾーン（飛行注意区域）表示切替 |
| `E` | 緊急用務空域表示切替 |
| `H` | ヘリポート表示切替 |
| `T` | ツールチップ表示切替 |
| `?` | ヘルプモーダル表示 |
| `Escape` | ヘルプ/ダイアログを閉じる |

### 飛行経路・飛行範囲の描画

サイドバーの「飛行経路／飛行範囲」パネルから各種描画ツールを使用できます。

#### 描画ツール

| ツール | 説明 |
|--------|------|
| **ポリゴン** | クリックで頂点を追加、最初の点をクリックで完了 |
| **円** | 半径を選択後、地図をクリックで配置 |
| **WP（ウェイポイント）** | クリックでポイントを配置（連続配置モード対応） |
| **経路** | クリックで頂点を追加、飛行経路のラインを描画 |

**WP連続配置モード**: WPツール選択時、「連続配置モード」チェックボックスで連続配置のON/OFFを切り替え可能。ONの場合はクリックするたびにWPが配置され、モードが継続します。

#### オブジェクト操作

| 操作 | 方法 |
|------|------|
| **選択** | オブジェクトをクリック |
| **複数選択** | `Shift` + ドラッグで範囲選択 |
| **移動** | オブジェクトをドラッグ |
| **編集** | 選択後「編集」ボタン → 頂点をドラッグで変形 |
| **削除** | 選択後 `Delete` または `Backspace` キー（確認ダイアログ表示） |
| **円のサイズ変更** | 円を選択後、サイズ変更セレクトボックスで調整 |

#### データ出力

- **座標コピー**: 描画したオブジェクトの座標をテキスト形式でクリップボードにコピー
- **データ出力**: GeoJSON形式でファイルダウンロード

### 住所・地名検索

検索バーから以下の検索が可能です：

- **市区町村名**: 「東京」「大阪」「福岡」など
- **住所**: 「渋谷区道玄坂」など
- **建物・施設名**: 「東京タワー」「スカイツリー」など
- **地域名**: 「那覇」「札幌」など

検索結果をクリックすると、該当位置に地図がズームします。

## プロジェクト構成

```
├── src/
│   ├── App.tsx      # メインアプリケーション
│   ├── main.tsx     # エントリーポイント
│   └── index.css    # スタイル
├── GeoJSON/         # DIDデータ（GeoJSON形式）
├── docs/            # ドキュメント
│   ├── PROJECT_REQUIREMENTS.md
│   └── UPDATE_REQUIREMENTS.md
└── scripts/         # ユーティリティスクリプト
    └── download_did_2020.sh
```

## データソース

| レイヤー | ソース | 形式 |
|----------|--------|------|
| 雨雲レーダー | RainViewer API | ラスタータイル |
| 人口集中地区（DID） | e-Stat | GeoJSON |
| 地理院地図タイル | 国土地理院 | ラスタータイル |
| 陰影起伏・標高図 | 国土地理院 | ラスタータイル |

## ライセンス・利用規約

### DIDデータ
本データは[政府統計の総合窓口（e-Stat）利用規約](https://www.e-stat.go.jp/terms-of-use)に基づき利用可能です。

- **自由利用可能**: 複製、公衆送信、翻訳・変形等が可能
- **商用利用可能**

利用する際は出典を記載してください：
```
出典：政府統計の総合窓口(e-Stat)（https://www.e-stat.go.jp/）
「人口集中地区」データを加工して作成
```

### 地理院タイル
[国土地理院コンテンツ利用規約](https://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html)に基づき利用可能です。

## 参考リンク

- [国土地理院 地理院地図](https://maps.gsi.go.jp/)
- [政府統計の総合窓口（e-Stat）](https://www.e-stat.go.jp/)
- [国土数値情報](https://nlftp.mlit.go.jp/ksj/)
