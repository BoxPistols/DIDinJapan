# Japan Overlay Map

日本の各種地理データをオーバーレイ表示できる汎用地図ライブラリです。

## Acknowledgements / 謝辞

本プロジェクトは [dronebird/DIDinJapan](https://github.com/dronebird/DIDinJapan) をベースにしています。

オリジナルプロジェクトの作者である **Taichi FURUHASHI ([@mapconcierge](https://github.com/mapconcierge))** 氏、**Nobusuke IWASAKI ([@wata909](https://github.com/wata909))** 氏に深く感謝いたします。

DIDデータのGeoJSON変換という基盤を構築していただいたことで、本プロジェクトの開発が可能となりました。

## 機能

### ベースマップ

- 標準（OpenStreetMap）
- 地理院地図
- 淡色地図
- 航空写真

### オーバーレイレイヤー

#### 空港周辺空域（ハイブリッド表示）

本アプリケーションでは、空港周辺の規制空域を以下の3種類のデータを組み合わせて正確に表示します：

1. **正確な敷地形状（GeoJSON）**:
   - 国土交通省「国土数値情報（C28 空港データ）」を使用
   - 実際の空港敷地（フェンス内）をポリゴンで正確に表示
2. **公式制限表面（タイル）**:
   - 国土地理院・航空局提供の「空港等の周辺空域」タイルを使用
   - 進入表面、転移表面、水平表面などの法規制エリアを可視化（都心部等）
3. **目安の警告エリア（円）**:
   - データ補完用の円形オーバーレイ（半径6km等）
   - 地方空港など、タイルデータが表示されない地域でも最低限の注意喚起が可能

#### 気象情報

**雨雲レーダー [C]**
- リアルタイム雨雲表示（5分ごと自動更新）
- RainViewer API連携（無料・認証不要）
- キーボードショートカット `C` でトグル

**天気予報クリックモード [W]**
- 地図上をクリックで都道府県の天気予報をポップアップ表示
- Open-Meteo API連携（無料・認証不要）
- 現在の気温・天気・湿度・風速・降水量
- 3日間の週間予報
- キーボードショートカット `W` でモードトグル

**都道府県別 詳細予報パネル**
- 全47都道府県対応
- 現在の天気詳細
- 48時間の時間ごと予報（スクロール表示）
- 7日間の週間予報
- ダークモード対応
- グラスモーフィズムUI
- ESCキーで閉じる

**使用API（全て無料・認証不要）**:
- [Open-Meteo API](https://open-meteo.com/) - 天気予報
- [RainViewer API](https://www.rainviewer.com/api.html) - 雨雲レーダー

#### 人口集中地区（DID）

- 全47都道府県のDIDデータを表示
- 地域別グループ化
- 透明度調整
- ホバー時のポップアップ情報（人口、面積、人口密度、市区町村コード）
- 一括表示/非表示切り替え
- **スマート検索機能**：市区町村を検索して地図を自動ズーム
  - 初期ロードは関東・近畿・中部の3地域のみ（高速化）
  - 検索結果がない場合、自動的にすべての都道府県をロード
  - 全国どの市区町村でも検索可能（例：「名護市」「神戸市」など）

#### 施設データ（参考）

- 有人機発着地
- 駐屯地・基地
- 消防署
- 医療機関（病院・診療所）
- データ生成: `npm run download:facilities`（OSMベース）
- 自治体データに差し替える場合は `public/data/facilities/` のGeoJSONを置換

#### 地理情報

- 陰影起伏図
- 色別標高図
- 傾斜量図

## セットアップ

```bash
npm install
npm run dev
```

ブラウザで <http://localhost:5173> を開きます。

## ビルド

```bash
npm run build
```

## 技術スタック

- React 18
- TypeScript
- MapLibre GL JS
- Vite
- Storybook 8

## 地図について

### 地図タイルの種類

このアプリケーションは複数の地図タイルプロバイダーに対応しています：

| 地図 | プロバイダ | 特徴 |
|------|-----------|------|
| **標準** | OpenStreetMap (OSM) | カラフルで詳細。世界中で利用可能 |
| **地理院地図** | 国土地理院 (GSI) | 日本の公式地理データ。最も正確 |
| **淡色地図** | 国土地理院 (GSI) | シンプルで見やすい。背景データとして最適 |
| **航空写真** | 国土地理院 (GSI) | 衛星画像。地形や施設の確認に有用 |
| **メルカトル図法** | 国土地理院 (GSI) | 明示的にメルカトル投影を指定 |

### 地図投影法（地図図法）

#### メルカトル図法とは

メルカトル図法は、球体の地球を平面の紙に表現する方法です。

**特徴：**

- ✅ **直線が直線のまま** - 航海や航空ナビゲーションに便利
- ✅ **角度が正確** - 方角の表示が正確
- ❌ **高緯度ほど拡大される** - グリーンランドが実際より大きく見える
- ❌ **面積が歪む** - 赤道付近が小さく、極に近いほど大きく見える

**具体例：**

```
実際の大きさ    メルカトル図法での見え方
グリーンランド  ◻       グリーンランド  ◼◼◼  (実際より大きい)
日本          ◻       日本          ◻
オーストラリア ◼       オーストラリア ◻    (実際より小さい)
```

**なぜこのアプリで使用？**

- 🗺️ Google Maps、Apple Maps、OpenStreetMap など、**世界中のWebサービスがメルカトル図法を採用**
- 📱 スマートフォンの地図アプリも同じ
- 🌍 Web地図の業界標準
- 🎯 ラスタータイル（画像タイル）はメルカトル投影用に最適化されている

### 座標系

このアプリケーションで使用する座標系：

| 座標系 | 説明 |
|--------|------|
| **WGS84** (EPSG:4326) | 全地球測位システム (GPS) で使用。緯度経度で位置を表現 |
| **Web Mercator** | Webアプリケーション用のメルカトル投影。ズーム可能な地図用 |

**例：** 東京駅

```
緯度経度 (WGS84)      : 35.6762° N, 139.7674° E
```

## 気象情報とオーバーレイ

本アプリケーションは複数の気象・地理データソースを統合しています。

### 実装済みのAPI

| レイヤー | データソース | APIキー | 状態 |
|---------|-----------|--------|------|
| **雨雲レーダー** | [RainViewer API](https://www.rainviewer.com/api.html) | 不要 | ✅ 本番運用可能 |
| **天気予報** | [Open-Meteo API](https://open-meteo.com/) | 不要 | ✅ 本番運用可能 |

#### 雨雲レーダー (RainViewer API)

- **エンドポイント**: `https://api.rainviewer.com/public/weather-maps.json`
- **更新頻度**: 5分ごと自動更新
- **データ**: 過去のレーダーデータと降水予報（nowcast）
- **APIキー**: 不要（無料サービス）
- **フォールバック**: API失敗時は `(見本)` マーク付きモックを表示
- **実装**: `src/lib/services/rainViewer.ts`

#### 天気予報 (Open-Meteo API)

- **エンドポイント**: `https://api.open-meteo.com/v1/forecast`
- **機能**: 気温、天気コード、湿度、風速、降水量
- **データ**: 現在の天気 + 48時間予報 + 7日間予報
- **APIキー**: 不要（無料サービス）
- **対応地域**: 全47都道府県（県庁所在地ベース）
- **実装**: `src/lib/services/weatherApi.ts`

### モック表示機能

デモンストレーション用のモックデータを使用:

- **建物（地物）**: `util/geo.ts`で生成
- **LTEカバレッジ**: ローカルモック（仮設置）

詳細は [NEXT_ACTION.md](./docs/NEXT_ACTION.md) のAPI仕様セクションを参照。

## 検索機能の使い方

### スマート検索（自動ロード）

左パネルの検索フォームで市区町村名を入力すると、自動的に地図がズームします。

```
例：
- 「栃木」と入力 → 栃木県のすべての市区町村が表示
- 「名護」と入力 → 沖縄県名護市が表示（未ロード層は自動ロード）
- 「奈良」と入力 → 奈良県のすべての市区町村が表示
```

### 検索の仕組み

1. **初期ロード**：アプリ起動時に関東・近畿・中部の3地域のデータをロード（高速化）
2. **検索実行**：ユーザーが市区町村名を入力すると即座に検索
3. **スマート自動ロード**：検索結果がない場合、自動的にすべての都道府県をロード
4. **再検索**：ロード完了後、自動的に検索を再実行

このアプローチにより：

- 初期ロード時間が短い（必要なデータだけ先読み）
- 全国どこの市区町村でも検索可能
- ユーザーは層の手動選択不要

### 検索可能なデータ

- **市区町村名**: 「東京」「大阪」「福岡」など
- **区（特別区）**: 「中央区」「渋谷区」など
- **市町村**: 「名古屋市」「京都市」など
- **町村**: 「南風原町」「読谷村」など

※データは2010年国勢調査ベースのため、その後の市町村合併は反映されていない場合があります。

## 操作方法

### キーボードショートカット

| キー | 機能 |
|------|------|
| `D` | DID（人口集中地区）表示切替 |
| `A` | 空港周辺空域表示切替 |
| `R` | レッドゾーン（飛行禁止区域）表示切替 |
| `Y` | イエローゾーン（飛行注意区域）表示切替 |
| `E` | 緊急用務空域表示切替 |
| `H` | ヘリポート表示切替 |
| `T` | ツールチップ表示切替 |
| `W` | 天気予報クリックモード切替 |
| `C` | 雨雲レーダー表示切替 |
| `L` | ダーク/ライトモード切替 |
| `2` | 2D表示 |
| `3` | 3D表示 |
| `?` | ヘルプモーダル表示 |
| `Escape` | 天気ポップアップ/パネル/ヘルプを閉じる |

### 飛行経路・飛行範囲の描画

サイドバーの「飛行経路／飛行範囲」パネルから各種描画ツールを使用できます。

#### 描画ツール

| ツール | 説明 |
|--------|------|
| **ポリゴン** | クリックで頂点を追加、最初の点をクリックで完了 |
| **円** | 半径を選択後、地図をクリックで配置 |
| **WP（ウェイポイント）** | クリックでポイントを配置（連続配置モード対応） |
| **経路** | クリックで頂点を追加、飛行経路のラインを描画 |

**WP連続配置モード**: WPツール選択時、「連続配置モード」チェックボックスで連続配置のON/OFFを切り替え可能。ONの場合はクリックするたびにWPが配置され、モードが継続します。

#### オブジェクト操作

| 操作 | 方法 |
|------|------|
| **選択** | オブジェクトをクリック |
| **複数選択** | `Shift` + ドラッグで範囲選択 |
| **移動** | オブジェクトをドラッグ |
| **編集** | 選択後「編集」ボタン → 頂点をドラッグで変形 |
| **削除** | 選択後 `Delete` または `Backspace` キー（確認ダイアログ表示） |
| **円のサイズ変更** | 円を選択後、サイズ変更セレクトボックスで調整 |

#### データ出力

- **座標コピー**: 描画したオブジェクトの座標をテキスト形式でクリップボードにコピー
- **データ出力**: GeoJSON形式でファイルダウンロード

### 住所・地名検索

検索バーから以下の検索が可能です：

- **市区町村名**: 「東京」「大阪」「福岡」など
- **住所**: 「渋谷区道玄坂」など
- **建物・施設名**: 「東京タワー」「スカイツリー」など
- **地域名**: 「那覇」「札幌」など

検索結果をクリックすると、該当位置に地図がズームします。

## プロジェクト構成

```
├── src/
│   ├── App.tsx      # メインアプリケーション
│   ├── main.tsx     # エントリーポイント
│   └── index.css    # スタイル
├── public/
│   └── GeoJSON/
│       └── 2020/    # 令和2年国勢調査DIDデータ
├── rawdata/         # ダウンロードしたシェープファイル（.gitignore対象）
├── docs/            # ドキュメント
└── scripts/         # データ取得・変換スクリプト
    ├── download_did_2020.py  # e-Statからダウンロード
    └── convert_did_2020.js   # シェープファイル→GeoJSON変換
    └── convert_airport_data.js # 国土数値情報 空港データ変換
```

## ドキュメント

プロジェクトの詳細なドキュメントは `docs/` ディレクトリに整理されています。

### 📂 ドキュメント構造

```
docs/
├── README.md              # 自動生成索引（全ドキュメントへのリンク）
├── data/                  # データ関連（5ファイル）
├── api/                   # API・外部連携（3ファイル）
├── specifications/        # 仕様書（2ファイル）
└── development/           # 開発ガイド（5ファイル）
```

### 🔍 ドキュメントの探し方

**[docs/README.md](./docs/README.md)** を参照してください。カテゴリ別に整理された索引から目的のドキュメントを探せます。

### ⚙️ 自動索引生成の仕組み

`docs/README.md` は自動生成されています：

```bash
npm run docs:index
```

**処理内容:**

1. `docs/` 配下の全Markdownファイルをスキャン
2. 各ファイルから `# タイトル` と説明文を自動抽出
3. ファイルパスから自動的にカテゴリを判定
4. カテゴリ別に整理された索引を生成

**新規ドキュメント追加時:**

- 適切なカテゴリディレクトリに `.md` ファイルを配置
- `npm run docs:index` を実行
- 自動的に索引が更新されます

詳細は [docs/README.md](./docs/README.md) の「この索引の仕組み」セクションを参照してください。

---

## DIDデータの更新

e-Stat（政府統計の総合窓口）から最新のDIDデータを取得し、GeoJSON形式に変換できます。

### 手順

```bash
# 1. e-Statから全47都道府県のDIDデータをダウンロード
npm run download:did

# 2. シェープファイルをGeoJSONに変換
npm run convert:did
```

### 仕様

- **ダウンロード**: e-Stat公式ダウンロードAPIを使用（スクレイピングではない）
- **レート制限**: サーバー負荷軽減のため3秒間隔で取得
- **既存スキップ**: ダウンロード済みファイルは自動的にスキップ
- **変換ツール**: mapshaper（JGD2011→WGS84座標変換）

## 空港データの更新

国土数値情報（MLIT）から最新の空港データ（C28）を取得し、GeoJSON形式に変換できます。

### 手順

1. [国土数値情報 空港データ](https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-P13.html) から Shape形式 をダウンロード
2. `rawdata/airport_surfaces/` フォルダにZIPファイルを配置
3. 以下のコマンドを実行：

```bash
npm run convert:airport
```

詳細は [docs/DID_DATA_UPDATE_GUIDE.md](./docs/DID_DATA_UPDATE_GUIDE.md) を参照してください。

## データソース

| レイヤー | ソース | 形式 |
|----------|--------|------|
| 雨雲レーダー | RainViewer API | ラスタータイル |
| 人口集中地区（DID） | e-Stat | GeoJSON |
| 有人機発着地 | OSM/自治体オープンデータ | GeoJSON |
| 駐屯地・基地 | OSM/自治体オープンデータ | GeoJSON |
| 消防署 | OSM/自治体オープンデータ | GeoJSON |
| 医療機関 | OSM/自治体オープンデータ | GeoJSON |
| 地理院地図タイル | 国土地理院 | ラスタータイル |
| 陰影起伏・標高図 | 国土地理院 | ラスタータイル |
| 空港敷地（C28） | 国土数値情報 | GeoJSON |
| 空港周辺空域 | 国土地理院 | ラスタータイル |

## データの扱いと注意

- **最終確認**: 実際の飛行可否は必ずDIPS・NOTAM・自治体の最新情報で確認してください。
- **DID**: 国勢調査の人口集中地区（e-Stat）に基づく統計データです。更新周期が長く、最新の市街地変化とずれる場合があります。
- **DIDの表示**: 地域別は必要な地域のみ読み込むため軽量です。全国一括は全都道府県を読み込むため重く、広域確認向きです。
- **空港周辺空域**: 国土地理院の空域タイルと国土数値情報の空港敷地を併用しています。
- **空港周辺空域の表示**: ズーム8未満は簡易表示、ズーム8以上で詳細表示に切り替わります。
- **施設データ**: OSM/自治体オープンデータを加工した参考情報です。公式の規制区分ではありません。
- **仮設置データ**: 緊急用務空域・有人機発着エリアなどは試験的表示です。

## ライセンス・利用規約

### 本プロジェクト

MIT License

本プロジェクトは [dronebird/DIDinJapan](https://github.com/dronebird/DIDinJapan) を基にしています。

### DIDデータ

本データは[政府統計の総合窓口（e-Stat）利用規約](https://www.e-stat.go.jp/terms-of-use)に基づき利用可能です。

- **自由利用可能**: 複製、公衆送信、翻訳・変形等が可能
- **商用利用可能**
- **出典表示必須**

利用する際は出典を記載してください：

```
出典：政府統計の総合窓口(e-Stat)（https://www.e-stat.go.jp/）
「人口集中地区」データを加工して作成
```

### 地理院タイル

[国土地理院コンテンツ利用規約](https://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html)に基づき利用可能です。

## 参考リンク

- [dronebird/DIDinJapan](https://github.com/dronebird/DIDinJapan) - 本プロジェクトのベース
- [国土地理院 地理院地図](https://maps.gsi.go.jp/)
- [政府統計の総合窓口（e-Stat）](https://www.e-stat.go.jp/)
- [国土数値情報](https://nlftp.mlit.go.jp/ksj/)
