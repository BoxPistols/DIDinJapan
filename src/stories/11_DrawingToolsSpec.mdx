import { Meta } from '@storybook/blocks'

<Meta title="Learning/11_DrawingToolsSpec" />

export const TableStyle = {
  table: { width: '100%', borderCollapse: 'collapse', margin: '16px 0' },
  thead: { backgroundColor: 'rgba(74, 158, 255, 0.1)', borderBottom: '2px solid rgba(74, 158, 255, 0.3)' },
  th: { padding: '12px', textAlign: 'left', fontWeight: 600 },
  tr: { borderBottom: '1px solid rgba(255, 255, 255, 0.1)' },
  td: { padding: '12px' },
  strong: { fontWeight: 700 }
}

# Drawing Tools Specification

このドキュメントは、アプリケーション内の描画ツール（DrawingTools）の機能仕様、特にデータ構造と高度取得ロジックの詳細について記述します。

## 概要

DrawingToolsは、ユーザーが地図上に飛行計画（経路、範囲、ポイント）を作図し、管理・エクスポートするための機能群です。
MapLibre GL上で動作し、Mapbox GL Drawライブラリを拡張して実装されています。

---

## 1. 図形タイプとデータ構造

システムでは以下の4つの図形タイプをサポートしています。

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>タイプ</th>
      <th style={TableStyle.th}>用途</th>
      <th style={TableStyle.th}>内部データ構造<br/><span style={{fontSize:'0.85em', opacity: 0.7}}>(Mapbox Draw)</span></th>
      <th style={TableStyle.th}>GeoJSONエクスポート形式</th>
      <th style={TableStyle.th}>備考</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Polygon</strong></td>
      <td style={TableStyle.td}>飛行範囲、禁止区域</td>
      <td style={TableStyle.td}><code>Polygon</code></td>
      <td style={TableStyle.td}><code>Polygon</code></td>
      <td style={TableStyle.td}></td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Circle</strong></td>
      <td style={TableStyle.td}>バッファゾーン、監視範囲</td>
      <td style={TableStyle.td}><code>Polygon</code><br/><span style={{fontSize:'0.85em', opacity: 0.7}}>(多角形近似)</span></td>
      <td style={TableStyle.td}><code>Point + properties.radiusM</code></td>
      <td style={TableStyle.td}>エクスポート時は中心点と半径として表現される特殊仕様</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Point (WP)</strong></td>
      <td style={TableStyle.td}>離着陸点、経由地</td>
      <td style={TableStyle.td}><code>Point</code></td>
      <td style={TableStyle.td}><code>Point</code></td>
      <td style={TableStyle.td}></td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Line (経路)</strong></td>
      <td style={TableStyle.td}>飛行ルート</td>
      <td style={TableStyle.td}><code>LineString</code></td>
      <td style={TableStyle.td}><code>LineString</code></td>
      <td style={TableStyle.td}></td>
    </tr>
  </tbody>
</table>

### プロパティ (Properties)

各図形は以下のプロパティを持ちます。

- `id`: 一意の識別子
- `name`: ユーザーが指定した名称（**全形式で必須・維持される**）
- `elevation`: 地表面の標高（海抜m）
- `flightHeight`: 対地高度（m）
- `maxAltitude`: 最大高度（海抜m） = `elevation` + `flightHeight`
- `radiusM`: 半経（m） ※Circleタイプのみ

---

## 2. 高度（標高）取得ロジック

各図形に対して「標高を取得」機能を実行した際、システムは**図形の代表点1箇所**の標高を国土地理院APIから取得し、その値を図形全体の標高として適用します。

### 代表点の決定ロジック

図形タイプごとの「代表点」は以下のルールで決定されます。

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>図形タイプ</th>
      <th style={TableStyle.th}>代表点の位置</th>
      <th style={TableStyle.th}>詳細</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Point (WP)</strong></td>
      <td style={TableStyle.td}>その地点</td>
      <td style={TableStyle.td}>ポイントの座標そのものを使用します。</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Circle</strong></td>
      <td style={TableStyle.td}>中心点</td>
      <td style={TableStyle.td}>円の中心座標を使用します。</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Polygon</strong></td>
      <td style={TableStyle.td}>重心 (Centroid)</td>
      <td style={TableStyle.td}>全頂点の座標の平均値を使用します。<br/><span style={{fontSize:'0.85em', opacity: 0.7}}>※形状によってはポリゴンの外側に代表点が来る場合があります（凹多角形など）。</span></td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Line (経路)</strong></td>
      <td style={TableStyle.td}>中点 (Midpoint)</td>
      <td style={TableStyle.td}>経路を構成する点列配列の<strong>中央のインデックス</strong>にある点を使用します。<br/><span style={{fontSize:'0.85em', opacity: 0.7}}>※地理的な中間地点ではなく、頂点数の中央です。</span></td>
    </tr>
  </tbody>
</table>

### 使用API

- **API名**: 国土地理院 標高タイルAPI
- **エンドポイント**: `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php`
- **パラメータ**: `lon` (経度), `lat` (緯度), `outtype=JSON`

### 制約事項・注意点

1. **単一点近似**:
    広範囲にわたるポリゴンや長い経路であっても、取得される標高は**代表点1箇所のみ**の値です。
    - **リスク**: 山間部などで、代表点は谷底だが、経路の一部が山頂を通るような場合、安全高度の計算に誤差が生じる可能性があります。
    - **対策**: 厳密な地形追従が必要な場合は、経路を細かく分割してWPを配置することを推奨します。

2. **円 (Circle) の扱い**:
    画面上では多角形として描画されていますが、エクスポート/インポート時は「中心点＋半径」の情報として扱われます。
    再インポート時には、指定された半径と頂点数（デフォルト24）に基づいて多角形が再生成されます。

---

## 3. エクスポート仕様

作成したデータは以下の形式でエクスポート可能です。

### GeoJSON

標準的なGeoJSONフォーマットです。他のGISソフト（QGISなど）との互換性が最も高い形式です。
今回の改修により、**Circleタイプを含む全形式で `name` プロパティが正しく出力**されます。

```json
{
  "type": "Feature",
  "properties": {
    "type": "circle",
    "name": "監視エリアA", // 名称
    "radiusM": 500,
    "center": [139.767, 35.681],
    "elevation": 15,
    "maxAltitude": 165
  },
  "geometry": {
    "type": "Point", // 円はPointとして表現
    "coordinates": [139.767, 35.681]
  }
}
```

### KML (Google Earth)

Google Earth等で表示可能な形式です。

- `<Placemark>` タグ内に名称 (`<name>`) が出力されます。
- 高度情報は `<ExtendedData>` および座標値（`lon,lat,alt`）に含まれます。

### CSV

Excel等で編集可能な形式です。

- ヘッダー: `Type,Name,Latitude,Longitude,Radius(m),MaxAltitude(m)`
- ポリゴンやラインは構成点ごとに `PolygonPoint`, `LinePoint` として複数行に出力されます。

### NOTAM (DMS形式)

航空局への申請等で使用される度分秒形式です。

- 形式: `N35°40'52.08" E139°46'04.50"`
- 日本測地系ではなく世界測地系（WGS84）に基づきます。
