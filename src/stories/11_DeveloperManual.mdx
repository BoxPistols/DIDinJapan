import { Meta } from '@storybook/blocks'

<Meta title="Learning/11_Mapå®Ÿè£…ã‚¬ã‚¤ãƒ‰" />

# MapLibre GL JS å®Ÿè£…ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€**MapLibreã‚’ä½¿ã£ãŸåœ°å›³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰æ–¹æ³•**ã¨ã€**ãã®èƒŒå¾Œã«ã‚ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã®è€ƒãˆæ–¹**ã‚’è§£èª¬ã—ã¾ã™ã€‚

å˜ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã ã‘ã§ãªãã€ã€Œãªãœã“ã®æ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã€ã€Œä½•ã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã‹ã€ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€å¿œç”¨åŠ›ã®ã‚ã‚‹å®Ÿè£…ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## Part 1: åœ°å›³ã‚¢ãƒ—ãƒªã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### åœ°å›³ã‚¢ãƒ—ãƒªã‚’æ§‹æˆã™ã‚‹3ã¤ã®å±¤

åœ°å›³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä»¥ä¸‹ã®3å±¤ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ã“ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã€è¨­è¨ˆã®ç¬¬ä¸€æ­©ã§ã™ã€‚

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¡¨ç¤ºå±¤ï¼ˆView Layerï¼‰                  â”‚
â”‚                                                        â”‚
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›®ã«ã™ã‚‹ã‚‚ã®                                â”‚
â”‚   ãƒ»ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆèƒŒæ™¯ã®åœ°å›³ç”»åƒï¼‰                       â”‚
â”‚   ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆDIDã€ç©ºæ¸¯ã€æç”»ã—ãŸå›³å½¢ãªã©ï¼‰              â”‚
â”‚   ãƒ»UIè¦ç´ ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  ãƒ‡ãƒ¼ã‚¿å±¤ï¼ˆData Layerï¼‰                â”‚
â”‚                                                        â”‚
â”‚   è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã¨ãã®ç®¡ç†                        â”‚
â”‚   ãƒ»GeoJSONãƒ•ã‚¡ã‚¤ãƒ«                                    â”‚
â”‚   ãƒ»ã‚¿ã‚¤ãƒ«ç”»åƒ                                         â”‚
â”‚   ãƒ»APIå¿œç­”                                            â”‚
â”‚   ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å±¤ï¼ˆInteractionï¼‰          â”‚
â”‚                                                        â”‚
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®å—ã‘å–ã‚Šã¨å‡¦ç†                          â”‚
â”‚   ãƒ»ã‚¯ãƒªãƒƒã‚¯ã€ãƒ›ãƒãƒ¼ã€ãƒ‰ãƒ©ãƒƒã‚°                          â”‚
â”‚   ãƒ»æç”»æ“ä½œ                                           â”‚
â”‚   ãƒ»æ¤œç´¢ã€ãƒ•ã‚£ãƒ«ã‚¿                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãªãœ3å±¤ã«åˆ†ã‘ã‚‹ã®ã‹**:

1. **è²¬å‹™ã®åˆ†é›¢**: è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’æ··ãœã‚‹ã¨ã€å¤‰æ›´ãŒå›°é›£ã«ãªã‚‹
2. **ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§**: ãƒ‡ãƒ¼ã‚¿å±¤ã¯ç´”ç²‹ãªé–¢æ•°ã¨ã—ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã§ãã‚‹
3. **å†åˆ©ç”¨æ€§**: åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’PCç‰ˆã¨ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§åˆ¥UIã§è¡¨ç¤ºã§ãã‚‹

---

### MapLibreã®å½¹å‰²

MapLibreã¯ä¸»ã«**è¡¨ç¤ºå±¤**ã‚’æ‹…å½“ã—ã¾ã™ãŒã€3å±¤ã™ã¹ã¦ã«é–¢ã‚ã‚Šã¾ã™ã€‚

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MapLibre GL JS                       â”‚
â”‚                                                              â”‚
â”‚  [è¡¨ç¤ºå±¤]         [ãƒ‡ãƒ¼ã‚¿å±¤]           [ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å±¤]   â”‚
â”‚  ãƒ»Canvasæç”»     ãƒ»ã‚¿ã‚¤ãƒ«å–å¾—          ãƒ»ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ      â”‚
â”‚  ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†   ãƒ»GeoJSONè§£æ         ãƒ»ãƒ‰ãƒ©ãƒƒã‚°/ã‚ºãƒ¼ãƒ      â”‚
â”‚  ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨   ãƒ»ã‚½ãƒ¼ã‚¹ç®¡ç†          ãƒ»ãƒ”ãƒƒã‚¯ï¼ˆé¸æŠï¼‰      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦ãªè¨­è¨ˆåˆ¤æ–­**:

MapLibreã¯ã€Œã‚½ãƒ¼ã‚¹ã€ã¨ã€Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚

- **ã‚½ãƒ¼ã‚¹ï¼ˆSourceï¼‰**: ãƒ‡ãƒ¼ã‚¿ãã®ã‚‚ã®ï¼ˆGeoJSONã€ã‚¿ã‚¤ãƒ«URLï¼‰
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆLayerï¼‰**: ãƒ‡ãƒ¼ã‚¿ã®è¦‹ã›æ–¹ï¼ˆè‰²ã€ç·šã®å¤ªã•ï¼‰

ã“ã®åˆ†é›¢ã«ã‚ˆã‚Šã€**åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã®è¦‹ãŸç›®ã§è¡¨ç¤º**ã§ãã¾ã™ã€‚ä¾‹ãˆã°1ã¤ã®GeoJSONã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã€å¡—ã‚Šã¤ã¶ã—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨å¢ƒç•Œç·šãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆ¥ã€…ã«å®šç¾©ã§ãã¾ã™ã€‚

---

## Part 2: åŸºæœ¬å®Ÿè£…ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### Step 1: ãƒãƒƒãƒ—ã®åˆæœŸåŒ–

**ã‚„ã‚‹ã“ã¨**: ç”»é¢ã«åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹

```javascript
import maplibregl from 'maplibre-gl';
import 'maplibre-gl/dist/maplibre-gl.css';

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
  center: [139.7671, 35.6812],
  zoom: 10
});
```

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸Šã®æ„å‘³**:

`new Map()`ã‚’å‘¼ã‚“ã æ™‚ç‚¹ã§ã€MapLibreã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™:

1. **Canvasè¦ç´ ã®ä½œæˆ**: WebGLæç”»é ˜åŸŸ
2. **ã‚¹ã‚¿ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿**: URLã‹ã‚‰åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’fetch
3. **ã‚¿ã‚¤ãƒ«ã®preload**: ç¾åœ¨ã®è¡¨ç¤ºç¯„å›²ã®ã‚¿ã‚¤ãƒ«ã‚’äº‹å‰å–å¾—

```text
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰] â†’ [new Map()] â†’ [CanvasåˆæœŸåŒ–] â†’ [ã‚¹ã‚¿ã‚¤ãƒ«fetch] â†’ [ã‚¿ã‚¤ãƒ«å–å¾—]
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

export const TableStyle = {
  table: { width: '100%', borderCollapse: 'collapse', margin: '16px 0' },
  thead: { backgroundColor: 'rgba(74, 158, 255, 0.1)', borderBottom: '2px solid rgba(74, 158, 255, 0.3)' },
  th: { padding: '12px', textAlign: 'left', fontWeight: 600 },
  tr: { borderBottom: '1px solid rgba(255, 255, 255, 0.1)' },
  td: { padding: '12px' },
  strong: { fontWeight: 700 }
}

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</th>
      <th style={TableStyle.th}>å½¹å‰²ãƒ»å†…å®¹</th>
      <th style={{...TableStyle.th, textAlign: 'center'}}>å¿…é ˆ</th>
      <th style={TableStyle.th}>ä¾å­˜é–¢ä¿‚</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>components/</strong></td>
      <td style={TableStyle.td}>åœ°å›³UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (DrawingTools, InfoPanelç­‰)</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>âœ…</td>
      <td style={TableStyle.td}>lib/ ã®å‹ã¨è¨­å®šã«ä¾å­˜</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>lib/</strong></td>
      <td style={TableStyle.td}>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã€APIã‚µãƒ¼ãƒ“ã‚¹</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>âœ…</td>
      <td style={TableStyle.td}>å¤–éƒ¨ä¾å­˜ãªã— (Core)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>utils/</strong></td>
      <td style={TableStyle.td}>ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç­‰ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>âœ…</td>
      <td style={TableStyle.td}>ä¸€éƒ¨UIãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¾å­˜</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><strong>styles/</strong></td>
      <td style={TableStyle.td}>ãƒ†ãƒ¼ãƒå®šç¾©ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>âœ…</td>
      <td style={TableStyle.td}>components/ ã§ä½¿ç”¨</td>
    </tr>
  </tbody>
</table>

### ä¸»è¦ãªçŠ¶æ…‹å¤‰æ•°

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>çŠ¶æ…‹</th>
      <th style={TableStyle.th}>å‹</th>
      <th style={TableStyle.th}>èª¬æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapRef</code></td>
      <td style={TableStyle.td}><code>useRef&lt;maplibregl.Map&gt;</code></td>
      <td style={TableStyle.td}>ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapLoaded</code></td>
      <td style={TableStyle.td}><code>useState&lt;boolean&gt;</code></td>
      <td style={TableStyle.td}>ãƒãƒƒãƒ—ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>baseMap</code></td>
      <td style={TableStyle.td}><code>useState&lt;BaseMapKey&gt;</code></td>
      <td style={TableStyle.td}>ç¾åœ¨ã®ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆ'osm', 'satellite'ç­‰ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>layerStates</code></td>
      <td style={TableStyle.td}><code>useState&lt;Map&lt;string, LayerState&gt;&gt;</code></td>
      <td style={TableStyle.td}>å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤ºçŠ¶æ…‹ç®¡ç†</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>darkMode</code></td>
      <td style={TableStyle.td}><code>useState&lt;boolean&gt;</code></td>
      <td style={TableStyle.td}>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ãƒ•ãƒ©ã‚°</td>
    </tr>
  </tbody>
</table>

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>å½¢å¼</th>
      <th style={TableStyle.th}>ç”¨é€”</th>
      <th style={TableStyle.th}>æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>GeoJSON</strong></td>
      <td style={TableStyle.td}>å°è¦æ¨¡åŒºåŸŸï¼ˆå¸‚åŒºç”ºæ‘ãƒ¬ãƒ™ãƒ«ï¼‰</td>
      <td style={TableStyle.td}>ã€œ 5MB</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Vector Tiles (MVT)</strong></td>
      <td style={TableStyle.td}>ä¸­è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ï¼ˆéƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ«ï¼‰</td>
      <td style={TableStyle.td}>5 - 100MB</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><strong>PMTiles</strong></td>
      <td style={TableStyle.td}>å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨å›½ãƒ¬ãƒ™ãƒ«ï¼‰</td>
      <td style={TableStyle.td}>100MB+</td>
    </tr>
  </tbody>
</table>

---

## ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ã‚­ãƒ¼ä¸€è¦§

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ã‚­ãƒ¼</th>
      <th style={TableStyle.th}>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</th>
      <th style={TableStyle.th}>èª¬æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>ui-settings</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã€ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—è¨­å®šã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>did-map-drawn-features</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>DrawingToolsã§æç”»ã—ãŸå›³å½¢ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>did-expanded-groups</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®éƒ½é“åºœçœŒã‚°ãƒ«ãƒ¼ãƒ—ã®é–‹é–‰çŠ¶æ…‹</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>map-view-state-once</code></td>
      <td style={TableStyle.td}>Session</td>
      <td style={TableStyle.td}>ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡æ›¿æ™‚ã®ãƒªãƒ­ãƒ¼ãƒ‰ç”¨ãƒ“ãƒ¥ãƒ¼ä½ç½®ä¿æŒ</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>restriction-visible-ids</code></td>
      <td style={TableStyle.td}>Session</td>
      <td style={TableStyle.td}>è¡¨ç¤ºä¸­ã®åˆ¶é™åŒºåŸŸãƒ¬ã‚¤ãƒ¤ãƒ¼IDä¸€è¦§</td>
    </tr>
  </tbody>
</table>

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ API

### DrawingTools

ä½œå›³æ©Ÿèƒ½ã‚’ä¸€æ‹¬æä¾›ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚å†…éƒ¨ã§ MapboxDraw ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã—ã¾ã™ã€‚

**Path**: `src/components/DrawingTools.tsx`

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>Prop</th>
      <th style={TableStyle.th}>Type</th>
      <th style={TableStyle.th}>Default</th>
      <th style={TableStyle.th}>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>map</code></td>
      <td style={TableStyle.td}><code>maplibregl.Map</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}><strong>å¿…é ˆ</strong> åˆæœŸåŒ–æ¸ˆã¿ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapLoaded</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>ãƒãƒƒãƒ—ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>onFeaturesChange</code></td>
      <td style={TableStyle.td}><code>(features: DrawnFeature[]) =&gt; void</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}>å›³å½¢ãŒè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã•ã‚ŒãŸæ™‚ã«ç™ºç«</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>darkMode</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>UIã‚’ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤º</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>embedded</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>ã‚µã‚¤ãƒ‰ãƒãƒ¼åŸ‹ã‚è¾¼ã¿ç”¨ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>onUndoRedoStateChange</code></td>
      <td style={TableStyle.td}><code>(state: UndoRedoState) =&gt; void</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}>Undo/Redoãƒœã‚¿ãƒ³ã®æ´»æ€§çŠ¶æ…‹ã‚’é€šçŸ¥</td>
    </tr>
  </tbody>
</table>

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦

**1. "Style is not loaded"**

```javascript
// âŒ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
const map = new maplibregl.Map({ ... });
map.addSource('src', { ... });  // ã‚¹ã‚¿ã‚¤ãƒ«æœªãƒ­ãƒ¼ãƒ‰

// âœ… æ­£ã—ã„
map.on('load', () => {
  map.addSource('src', { ... });
});
```

**2. "Source already exists"**

```javascript
// âŒ 2å›è¿½åŠ ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼
map.addSource('src', { ... });
map.addSource('src', { ... });

// âœ… å­˜åœ¨ãƒã‚§ãƒƒã‚¯
if (!map.getSource('src')) {
  map.addSource('src', { ... });
}
```

**3. "Layer not found"**

```javascript
// âŒ å­˜åœ¨ã—ãªã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ“ä½œ
map.setLayoutProperty('unknown-layer', 'visibility', 'none');

// âœ… å­˜åœ¨ãƒã‚§ãƒƒã‚¯
if (map.getLayer('my-layer')) {
  map.setLayoutProperty('my-layer', 'visibility', 'none');
}
```

**4. WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸Šé™ã‚¨ãƒ©ãƒ¼**

ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¸Šé™ï¼ˆ8ã€œ16å€‹ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒƒãƒ—ã‚’ç ´æ£„ã›ãšã«å†ä½œæˆã‚’ç¹°ã‚Šè¿”ã™ã¨ç™ºç”Ÿã—ã¾ã™ã€‚

```javascript
// âŒ è§£æ”¾å¿˜ã‚Œ
useEffect(() => {
  const map = new maplibregl.Map({ ... });
  mapRef.current = map;
}, []);

// âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã§è§£æ”¾
useEffect(() => {
  const map = new maplibregl.Map({ ... });
  mapRef.current = map;
  
  return () => {
    map.remove();  // WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ”¾
  };
}, []);
```

**5. Next.js ã§ã® "window is not defined"**

MapLibreã¯ãƒ–ãƒ©ã‚¦ã‚¶APIã«ä¾å­˜ã™ã‚‹ãŸã‚ã€SSRæ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```tsx
// âœ… Dynamic Importã§å›é¿
import dynamic from 'next/dynamic';

const MapComponent = dynamic(() => import('./MapComponent'), {
  ssr: false,
  loading: () => <div>Loading map...</div>
});
```

---

## ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®è©³ç´°

### ã‚½ãƒ¼ã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é–¢ä¿‚

MapLibreã®æœ€ã‚‚é‡è¦ãªæ¦‚å¿µã¯ã€Œã‚½ãƒ¼ã‚¹ã€ã¨ã€Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã®åˆ†é›¢ã§ã™ã€‚

```text
[GeoJSON ã‚½ãƒ¼ã‚¹]
       â”‚
       â”œâ”€â”€ fillãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¡—ã‚Šã¤ã¶ã—ï¼‰
       â”‚
       â”œâ”€â”€ lineãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¢ƒç•Œç·šï¼‰
       â”‚
       â””â”€â”€ symbolãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰
```

1ã¤ã®ã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦è¤‡æ•°ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å®šç¾©ã§ãã€ãã‚Œãã‚Œç‹¬ç«‹ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ã‚¤ãƒ—ä¸€è¦§

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>Type</th>
      <th style={TableStyle.th}>ç”¨é€”</th>
      <th style={TableStyle.th}>å¯¾è±¡Geometry</th>
      <th style={TableStyle.th}>ä¸»ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>fill</code></td>
      <td style={TableStyle.td}>ãƒãƒªã‚´ãƒ³ã®å¡—ã‚Šã¤ã¶ã—</td>
      <td style={TableStyle.td}>Polygon, MultiPolygon</td>
      <td style={TableStyle.td}>fill-color, fill-opacity</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>line</code></td>
      <td style={TableStyle.td}>ç·šã®æç”»</td>
      <td style={TableStyle.td}>LineString, Polygonå¢ƒç•Œ</td>
      <td style={TableStyle.td}>line-color, line-width</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>circle</code></td>
      <td style={TableStyle.td}>ç‚¹ã‚’å††ã§è¡¨ç¤º</td>
      <td style={TableStyle.td}>Point</td>
      <td style={TableStyle.td}>circle-radius, circle-color</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>symbol</code></td>
      <td style={TableStyle.td}>ã‚¢ã‚¤ã‚³ãƒ³/ãƒ†ã‚­ã‚¹ãƒˆ</td>
      <td style={TableStyle.td}>Point</td>
      <td style={TableStyle.td}>text-field, icon-image</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>heatmap</code></td>
      <td style={TableStyle.td}>ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</td>
      <td style={TableStyle.td}>Point</td>
      <td style={TableStyle.td}>heatmap-intensity, heatmap-color</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>fill-extrusion</code></td>
      <td style={TableStyle.td}>3Då»ºç‰©</td>
      <td style={TableStyle.td}>Polygon</td>
      <td style={TableStyle.td}>fill-extrusion-height</td>
    </tr>
  </tbody>
</table>

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤ºé †åˆ¶å¾¡

ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è¿½åŠ é †ã«é‡ãªã‚Šã¾ã™ã€‚å¾Œã‹ã‚‰è¿½åŠ ã—ãŸã‚‚ã®ãŒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```javascript
// ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸‹ã«æŒ¿å…¥
map.addLayer({
  id: 'my-layer',
  type: 'fill',
  source: 'my-source',
  paint: { 'fill-color': '#ff0000' }
}, 'waterway-label');  // ç¬¬2å¼•æ•°ã§æŒ¿å…¥ä½ç½®ã‚’æŒ‡å®š
```

---

## ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ã‚¤ãƒ™ãƒ³ãƒˆ</th>
      <th style={TableStyle.th}>ç™ºç«ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th>
      <th style={TableStyle.th}>ä¸»ãªç”¨é€”</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>load</code></td>
      <td style={TableStyle.td}>ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†æ™‚</td>
      <td style={TableStyle.td}>ã‚½ãƒ¼ã‚¹/ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ã®é–‹å§‹ç‚¹</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>click</code></td>
      <td style={TableStyle.td}>ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ™‚</td>
      <td style={TableStyle.td}>ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é¸æŠã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mousemove</code></td>
      <td style={TableStyle.td}>ãƒã‚¦ã‚¹ç§»å‹•æ™‚</td>
      <td style={TableStyle.td}>ãƒ›ãƒãƒ¼è¡¨ç¤ºã€åº§æ¨™è¡¨ç¤º</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>moveend</code></td>
      <td style={TableStyle.td}>ãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ å®Œäº†æ™‚</td>
      <td style={TableStyle.td}>è¡¨ç¤ºç¯„å›²ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>zoom</code></td>
      <td style={TableStyle.td}>ã‚ºãƒ¼ãƒ å¤‰æ›´ä¸­</td>
      <td style={TableStyle.td}>ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã®æ›´æ–°</td>
    </tr>
  </tbody>
</table>

### ãƒ¬ã‚¤ãƒ¤ãƒ¼å›ºæœ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ

```javascript
// ç‰¹å®šãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®ã¿ç™ºç«
map.on('click', 'did-layer', (e) => {
  const feature = e.features[0];
  console.log(feature.properties);
});

// ãƒ›ãƒãƒ¼æ™‚ã®ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´
map.on('mouseenter', 'did-layer', () => {
  map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'did-layer', () => {
  map.getCanvas().style.cursor = '';
});
```

---

## æç”»ãƒ„ãƒ¼ãƒ« (MapboxDraw)

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

MapboxDrawã¯ç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ã—ã¦å‹•ä½œã—ã€å†…éƒ¨ã§ç‹¬è‡ªã®ã‚½ãƒ¼ã‚¹/ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç®¡ç†ã—ã¾ã™ã€‚

```text
map.addControl(draw)
     â”‚
     â”œâ”€â”€ mapbox-gl-draw-cold-sourceï¼ˆç¢ºå®šæ¸ˆã¿å›³å½¢ï¼‰
     â”œâ”€â”€ mapbox-gl-draw-hot-sourceï¼ˆæç”»ä¸­å›³å½¢ï¼‰
     â”‚
     â””â”€â”€ ç´„20å€‹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆfill, line, é ‚ç‚¹ç­‰ï¼‰
```

### ä¸»è¦API

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ãƒ¡ã‚½ãƒƒãƒ‰</th>
      <th style={TableStyle.th}>èª¬æ˜</th>
      <th style={TableStyle.th}>æˆ»ã‚Šå€¤</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>draw.getAll()</code></td>
      <td style={TableStyle.td}>å…¨ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’GeoJSONã§å–å¾—</td>
      <td style={TableStyle.td}>FeatureCollection</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>draw.add(feature)</code></td>
      <td style={TableStyle.td}>ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’è¿½åŠ </td>
      <td style={TableStyle.td}>è¿½åŠ ã•ã‚ŒãŸIDé…åˆ—</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>draw.delete(id)</code></td>
      <td style={TableStyle.td}>æŒ‡å®šIDã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’å‰Šé™¤</td>
      <td style={TableStyle.td}>å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>draw.set(fc)</code></td>
      <td style={TableStyle.td}>å…¨ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’ç½®æ›</td>
      <td style={TableStyle.td}>è¿½åŠ ã•ã‚ŒãŸIDé…åˆ—</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>draw.changeMode(mode)</code></td>
      <td style={TableStyle.td}>æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’å¤‰æ›´</td>
      <td style={TableStyle.td}>void</td>
    </tr>
  </tbody>
</table>

### æç”»ã‚¤ãƒ™ãƒ³ãƒˆ

```javascript
map.on('draw.create', (e) => {
  console.log('Created:', e.features);
});

map.on('draw.update', (e) => {
  console.log('Updated:', e.features);
});

map.on('draw.delete', (e) => {
  console.log('Deleted:', e.features);
});

map.on('draw.selectionchange', (e) => {
  console.log('Selected:', e.features);
});
```

### å††ã®æç”»ï¼ˆã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ï¼‰

GeoJSONã«ã¯ã€Œå††ã€ãŒãªã„ãŸã‚ã€å¤šè§’å½¢ã§è¿‘ä¼¼ã—ã¾ã™ã€‚

```typescript
function createCirclePolygon(
  center: [number, number],
  radiusKm: number,
  points: number = 64
): GeoJSON.Feature<GeoJSON.Polygon> {
  const [lng, lat] = center;
  const coords: [number, number][] = [];
  
  // ç·¯åº¦ã«ã‚ˆã‚‹çµŒåº¦æ–¹å‘ã®è£œæ­£
  const latRad = lat * Math.PI / 180;
  const lngPerKm = 1 / (111.32 * Math.cos(latRad));
  const latPerKm = 1 / 110.574;

  for (let i = 0; i <= points; i++) {
    const angle = (i / points) * 2 * Math.PI;
    const dx = radiusKm * Math.cos(angle) * lngPerKm;
    const dy = radiusKm * Math.sin(angle) * latPerKm;
    coords.push([lng + dx, lat + dy]);
  }

  return {
    type: 'Feature',
    properties: { 
      isCircle: true, 
      center, 
      radiusKm 
    },
    geometry: { 
      type: 'Polygon', 
      coordinates: [coords] 
    }
  };
}
```

---

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

### IndexedDB ã«ã‚ˆã‚‹GeoJSONã‚­ãƒ£ãƒƒã‚·ãƒ¥

å¤§ããªGeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã¯IndexedDBã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€2å›ç›®ä»¥é™ã®èª­ã¿è¾¼ã¿ã‚’é«˜é€ŸåŒ–ã§ãã¾ã™ã€‚

```typescript
const DB_NAME = 'did-map-cache';
const STORE_NAME = 'geojson';
const CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7æ—¥

async function fetchWithCache<T>(url: string): Promise<T> {
  // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
  const cached = await getCachedData(url);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL_MS) {
    return cached.data;
  }

  // 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—
  const response = await fetch(url);
  const data = await response.json();

  // 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  await setCachedData(url, { data, timestamp: Date.now() });

  return data;
}
```

### é…å»¶èª­ã¿è¾¼ã¿ãƒ‘ã‚¿ãƒ¼ãƒ³

éƒ½é“åºœçœŒå˜ä½ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã—ã€å¿…è¦ãªæ™‚ã«ã®ã¿èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```typescript
const loadedLayers = new Set<string>();

async function loadLayerIfNeeded(layerId: string, path: string) {
  if (loadedLayers.has(layerId)) return;
  
  const geojson = await fetchWithCache(path);
  
  map.addSource(layerId, { type: 'geojson', data: geojson });
  map.addLayer({
    id: layerId,
    type: 'fill',
    source: layerId,
    paint: { 'fill-color': '#ff6b6b', 'fill-opacity': 0.5 }
  });
  
  loadedLayers.add(layerId);
}
```

---

## å¤–éƒ¨APIé€£æº

### æ¨™é«˜å–å¾— (GSI DEM API)

å›½åœŸåœ°ç†é™¢ã®æ¨™é«˜APIã‚’ä½¿ç”¨ã—ã¦ã€ä»»æ„ã®åº§æ¨™ã®æ¨™é«˜ã‚’å–å¾—ã§ãã¾ã™ã€‚

```typescript
async function fetchElevation(lng: number, lat: number): Promise<number | null> {
  const url = `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon=${lng}&lat=${lat}&outtype=JSON`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    return data.elevation ?? null;
  } catch {
    return null;
  }
}
```

### ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (Nominatim)

ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’æ¤œç´¢ã™ã‚‹ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã§ã™ã€‚

```typescript
async function geocode(query: string): Promise<GeocodeResult[]> {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=jp`;
  
  const response = await fetch(url, {
    headers: { 'User-Agent': 'DID-J26-App/1.0' }
  });
  
  const data = await response.json();
  return data.map((item: any) => ({
    name: item.display_name,
    lat: parseFloat(item.lat),
    lng: parseFloat(item.lon)
  }));
}
```

---

## ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ã‚­ãƒ¼</th>
      <th style={TableStyle.th}>æ©Ÿèƒ½</th>
      <th style={TableStyle.th}>ã‚¹ã‚³ãƒ¼ãƒ—</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>D</code></td>
      <td style={TableStyle.td}>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</td>
      <td style={TableStyle.td}>ã‚°ãƒ­ãƒ¼ãƒãƒ«</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>M</code></td>
      <td style={TableStyle.td}>ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡æ›¿</td>
      <td style={TableStyle.td}>ã‚°ãƒ­ãƒ¼ãƒãƒ«</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>Ctrl+Z</code></td>
      <td style={TableStyle.td}>Undo</td>
      <td style={TableStyle.td}>DrawingTools</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>Ctrl+Shift+Z</code></td>
      <td style={TableStyle.td}>Redo</td>
      <td style={TableStyle.td}>DrawingTools</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>Delete</code></td>
      <td style={TableStyle.td}>é¸æŠå›³å½¢ã®å‰Šé™¤</td>
      <td style={TableStyle.td}>DrawingTools</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>Escape</code></td>
      <td style={TableStyle.td}>æç”»/é¸æŠã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«</td>
      <td style={TableStyle.td}>DrawingTools</td>
    </tr>
  </tbody>
</table>

---

## å‹å®šç¾©

### ä¸»è¦ãªå‹

```typescript
// ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ã®ã‚­ãƒ¼
type BaseMapKey = 'osm' | 'gsi' | 'pale' | 'photo';

// ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹
interface LayerState {
  loaded: boolean;
  visible: boolean;
}

// æç”»ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼
interface DrawnFeature {
  id: string;
  type: 'polygon' | 'circle' | 'point' | 'line';
  name: string;
  coordinates: GeoJSON.Position | GeoJSON.Position[] | GeoJSON.Position[][];
  radius?: number;        // å††ã®å ´åˆ
  center?: [number, number]; // å††ã®å ´åˆ
  elevation?: number;
  flightHeight?: number;
  maxAltitude?: number;
}

// ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
interface LayerConfig {
  id: string;
  name: string;
  path: string;
  color: string;
}
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã¯`/public`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

```text
/public
  â””â”€â”€ GeoJSON
        â””â”€â”€ 2020
              â”œâ”€â”€ r02_did_01_hokkaido.geojson  (2.1MB)
              â”œâ”€â”€ r02_did_13_tokyo.geojson     (1.8MB)
              â””â”€â”€ ...
```

### ç’°å¢ƒå¤‰æ•°

```bash
# .env.local
VITE_MAPTILER_KEY=your_api_key
VITE_GSI_TILE_URL=https://cyberjapandata.gsi.go.jp/xyz
```

### Vercelè¨­å®š

```json
{
  "buildCommand": "pnpm build",
  "outputDirectory": "dist",
  "headers": [
    {
      "source": "/GeoJSON/(.*)",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=604800" }
      ]
    }
  ]
}
```

---

## Part 7: GitHub CLI æ´»ç”¨ã‚¬ã‚¤ãƒ‰

GitHub CLI (`gh`) ã‚’ä½¿ã£ãŸåŠ¹ç‡çš„ãªé–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€æ‹¬æ“ä½œãªã©ã€å®Ÿè·µçš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’è§£èª¬ã—ã¾ã™ã€‚

### GitHub CLI åŸºç¤

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èªè¨¼

```bash
# macOS (Homebrew)
brew install gh

# åˆå›èªè¨¼
gh auth login

# èªè¨¼çŠ¶æ…‹ç¢ºèª
gh auth status
```

#### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰

```bash
# PRä¸€è¦§
gh pr list

# PRä½œæˆ
gh pr create --title "feat: æ–°æ©Ÿèƒ½è¿½åŠ " --body "è©³ç´°ãªèª¬æ˜"

# PRè©³ç´°è¡¨ç¤º
gh pr view 8

# PRã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
gh pr view 8 --web
```

---

### GraphQL API ã®æ´»ç”¨

GitHub CLI ã¯ GraphQL API ã‚’ç›´æ¥å©ã‘ã‚‹ãŸã‚ã€RESTã‚ˆã‚Šã‚‚æŸ”è»Ÿãªæ“ä½œãŒå¯èƒ½ã§ã™ã€‚

#### Queryï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰

```bash
gh api graphql -f query='
{
  repository(owner: "BoxPistols", name: "DID-J26") {
    pullRequest(number: 8) {
      reviewThreads(first: 50) {
        nodes {
          id
          isResolved
          comments(first: 1) {
            nodes {
              body
              path
            }
          }
        }
      }
    }
  }
}'
```

#### Mutationï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ï¼‰

```bash
gh api graphql -f query='
mutation {
  resolveReviewThread(input: {threadId: "PRRT_xxx"}) {
    thread {
      id
      isResolved
    }
  }
}
'
```

---

### PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€æ‹¬æ“ä½œ

**å®Ÿè·µä¾‹ï¼šPR #8 ã®å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ‹¬ã§ Resolve ã™ã‚‹**

#### ã‚¹ãƒ†ãƒƒãƒ—1: æœªè§£æ±ºã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å–å¾—

```bash
gh api graphql -f query='
{
  repository(owner: "BoxPistols", name: "DID-J26") {
    pullRequest(number: 8) {
      reviewThreads(first: 50) {
        nodes {
          id
          isResolved
          comments(first: 1) {
            nodes {
              body
              path
            }
          }
        }
      }
    }
  }
}' --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | {id: .id, path: .comments.nodes[0].path}'
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ä¸€æ‹¬Resolveå®Ÿè¡Œ

```bash
#!/bin/bash
# resolve_threads.sh

THREAD_IDS=(
  "PRRT_kwDOQ2E2785p3NzQ"
  "PRRT_kwDOQ2E2785p3NzT"
  "PRRT_kwDOQ2E2785p3NzU"
  # ... å…¨ã‚¹ãƒ¬ãƒƒãƒ‰ID
)

for thread_id in "${THREAD_IDS[@]}"; do
  echo "Resolving thread: $thread_id"

  gh api graphql -f query="
    mutation {
      resolveReviewThread(input: {threadId: \"$thread_id\"}) {
        thread {
          id
          isResolved
        }
      }
    }
  " --jq '.data.resolveReviewThread.thread | "âœ… Resolved: \(.id) - isResolved: \(.isResolved)"'
done

echo "All threads resolved! âœ…"
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ç¢ºèª

```bash
gh api graphql -f query='
{
  repository(owner: "BoxPistols", name: "DID-J26") {
    pullRequest(number: 8) {
      reviewThreads(first: 50) {
        totalCount
        nodes {
          isResolved
        }
      }
    }
  }
}' --jq '{
  totalThreads: .data.repository.pullRequest.reviewThreads.totalCount,
  resolved: [.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == true)] | length,
  unresolved: [.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length
}'
```

**çµæœ:**
```json
{
  "totalThreads": 15,
  "resolved": 15,
  "unresolved": 0
}
```

---

### å®Ÿè·µä¾‹é›†

#### ä¾‹1: æœªè§£æ±ºPRã‚³ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•é€šçŸ¥

```bash
#!/bin/bash
PR_NUMBER=8
UNRESOLVED=$(gh api graphql -f query="..." --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length')

if [ "$UNRESOLVED" -gt 0 ]; then
  echo "âš ï¸  PR #$PR_NUMBER has $UNRESOLVED unresolved comments!"
else
  echo "âœ… All comments resolved!"
fi
```

#### ä¾‹2: ç‰¹å®šãƒ©ãƒ™ãƒ«ã®Issueã‚’ä¸€æ‹¬ã‚¯ãƒ­ãƒ¼ã‚º

```bash
#!/bin/bash
ISSUES=$(gh issue list --label "wontfix" --json number --jq '.[].number')

for issue in $ISSUES; do
  echo "Closing issue #$issue"
  gh issue close $issue --comment "Outdated issue. Closing."
done
```

#### ä¾‹3: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ

```bash
#!/bin/bash
PREVIOUS_TAG="v1.0.0"
CURRENT_TAG="v1.1.0"

echo "# Release Notes: $CURRENT_TAG"
echo ""
echo "## ğŸ‰ New Features"
gh api repos/BoxPistols/DID-J26/compare/$PREVIOUS_TAG...$CURRENT_TAG \
  --jq '.commits[] | select(.commit.message | startswith("feat")) | "- \(.commit.message | split("\n")[0])"'
```

---

### jqã§ãƒ‡ãƒ¼ã‚¿æ•´å½¢

```bash
# PRä¸€è¦§ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã®ã¿è¡¨ç¤º
gh pr list --json number,title,url --jq '.[] | "\(.number): \(.title) - \(.url)"'

# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
--jq '.[] | select(.state == "OPEN")'

# ã‚«ã‚¦ãƒ³ãƒˆ
--jq '.[] | length'

# ã‚½ãƒ¼ãƒˆ
--jq 'sort_by(.createdAt)'
```

---

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### ã‚¨ãƒ©ãƒ¼1: èªè¨¼ã‚¨ãƒ©ãƒ¼

```bash
# å†èªè¨¼
gh auth logout
gh auth login
```

#### ã‚¨ãƒ©ãƒ¼2: Rate Limit

```bash
# Rate limitçŠ¶æ³ç¢ºèª
gh api rate_limit

# å‡ºåŠ›:
# {
#   "resources": {
#     "core": {
#       "limit": 5000,
#       "remaining": 0,
#       "reset": 1705612800
#     }
#   }
# }
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

### MapLibreé–¢é€£
- [MapLibre GL JS Documentation](https://maplibre.org/maplibre-gl-js-docs/)
- [Mapbox GL Draw](https://github.com/mapbox/mapbox-gl-draw)
- [å›½åœŸåœ°ç†é™¢ã‚¿ã‚¤ãƒ«ä¸€è¦§](https://maps.gsi.go.jp/development/ichiran.html)
- [GeoJSON RFC 7946](https://datatracker.ietf.org/doc/html/rfc7946)

### GitHub CLIé–¢é€£
- [GitHub CLI Manual](https://cli.github.com/manual/)
- [GitHub GraphQL API](https://docs.github.com/en/graphql)
- [GitHub GraphQL Explorer](https://docs.github.com/en/graphql/overview/explorer)
- [jq Manual](https://stedolan.github.io/jq/manual/)
