import { Meta } from '@storybook/blocks'

<Meta title="Learning/11_Map実装ガイド" />

# MapLibre GL JS 実装ガイド

このガイドは、**MapLibreを使った地図アプリケーションの構築方法**と、**その背後にあるアーキテクチャ設計の考え方**を解説します。

単にコードを書くだけでなく、「なぜこの構造になっているのか」「何を解決しようとしているのか」を理解することで、応用力のある実装ができるようになります。

---

## Part 1: 地図アプリのアーキテクチャ

### 地図アプリを構成する3つの層

地図アプリケーションは、以下の3層で構成されます。この構造を理解することが、設計の第一歩です。

```text
┌───────────────────────────────────────────────────────┐
│                  表示層（View Layer）                  │
│                                                        │
│   ユーザーが目にするもの                                │
│   ・ベースマップ（背景の地図画像）                       │
│   ・レイヤー（DID、空港、描画した図形など）              │
│   ・UI要素（ポップアップ、コントロール）                 │
├───────────────────────────────────────────────────────┤
│                  データ層（Data Layer）                │
│                                                        │
│   表示するためのデータとその管理                        │
│   ・GeoJSONファイル                                    │
│   ・タイル画像                                         │
│   ・API応答                                            │
│   ・キャッシュ                                         │
├───────────────────────────────────────────────────────┤
│              インタラクション層（Interaction）          │
│                                                        │
│   ユーザー操作の受け取りと処理                          │
│   ・クリック、ホバー、ドラッグ                          │
│   ・描画操作                                           │
│   ・検索、フィルタ                                     │
└───────────────────────────────────────────────────────┘
```

**なぜ3層に分けるのか**:

1. **責務の分離**: 表示ロジックとデータ取得を混ぜると、変更が困難になる
2. **テスト容易性**: データ層は純粋な関数として単体テストできる
3. **再利用性**: 同じデータをPC版とモバイル版で別UIで表示できる

---

### MapLibreの役割

MapLibreは主に**表示層**を担当しますが、3層すべてに関わります。

```text
┌─────────────────────────────────────────────────────────────┐
│                         MapLibre GL JS                       │
│                                                              │
│  [表示層]         [データ層]           [インタラクション層]   │
│  ・Canvas描画     ・タイル取得          ・マウスイベント      │
│  ・レイヤー管理   ・GeoJSON解析         ・ドラッグ/ズーム     │
│  ・スタイル適用   ・ソース管理          ・ピック（選択）      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**重要な設計判断**:

MapLibreは「ソース」と「レイヤー」を明確に分離しています。

- **ソース（Source）**: データそのもの（GeoJSON、タイルURL）
- **レイヤー（Layer）**: データの見せ方（色、線の太さ）

この分離により、**同じデータを複数の見た目で表示**できます。例えば1つのGeoJSONソースに対して、塗りつぶしレイヤーと境界線レイヤーを別々に定義できます。

---

## Part 2: 基本実装とアーキテクチャ

### Step 1: マップの初期化

**やること**: 画面に地図を表示する

```javascript
import maplibregl from 'maplibre-gl';
import 'maplibre-gl/dist/maplibre-gl.css';

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
  center: [139.7671, 35.6812],
  zoom: 10
});
```

**アーキテクチャ上の意味**:

`new Map()`を呼んだ時点で、MapLibreは以下を実行します:

1. **Canvas要素の作成**: WebGL描画領域
2. **スタイルの読み込み**: URLから地図スタイルをfetch
3. **タイルのpreload**: 現在の表示範囲のタイルを事前取得

```text
[ユーザーコード] → [new Map()] → [Canvas初期化] → [スタイルfetch] → [タイル取得]
```

### ディレクトリ構成

export const TableStyle = {
  table: { width: '100%', borderCollapse: 'collapse', margin: '16px 0' },
  thead: { backgroundColor: 'rgba(74, 158, 255, 0.1)', borderBottom: '2px solid rgba(74, 158, 255, 0.3)' },
  th: { padding: '12px', textAlign: 'left', fontWeight: 600 },
  tr: { borderBottom: '1px solid rgba(255, 255, 255, 0.1)' },
  td: { padding: '12px' },
  strong: { fontWeight: 700 }
}

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ディレクトリ</th>
      <th style={TableStyle.th}>役割・内容</th>
      <th style={{...TableStyle.th, textAlign: 'center'}}>必須</th>
      <th style={TableStyle.th}>依存関係</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>components/</strong></td>
      <td style={TableStyle.td}>地図UIコンポーネント (DrawingTools, InfoPanel等)</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>✅</td>
      <td style={TableStyle.td}>lib/ の型と設定に依存</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>lib/</strong></td>
      <td style={TableStyle.td}>ビジネスロジック、データモデル、APIサービス</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>✅</td>
      <td style={TableStyle.td}>外部依存なし (Core)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>utils/</strong></td>
      <td style={TableStyle.td}>トースト通知、ダイアログ等のヘルパー</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>✅</td>
      <td style={TableStyle.td}>一部UIライブラリに依存</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><strong>styles/</strong></td>
      <td style={TableStyle.td}>テーマ定義、グローバル変数</td>
      <td style={{...TableStyle.td, textAlign: 'center'}}>✅</td>
      <td style={TableStyle.td}>components/ で使用</td>
    </tr>
  </tbody>
</table>

### 主要な状態変数

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>状態</th>
      <th style={TableStyle.th}>型</th>
      <th style={TableStyle.th}>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapRef</code></td>
      <td style={TableStyle.td}><code>useRef&lt;maplibregl.Map&gt;</code></td>
      <td style={TableStyle.td}>マップインスタンス（再レンダリング不要）</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapLoaded</code></td>
      <td style={TableStyle.td}><code>useState&lt;boolean&gt;</code></td>
      <td style={TableStyle.td}>マップのロード完了フラグ</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>baseMap</code></td>
      <td style={TableStyle.td}><code>useState&lt;BaseMapKey&gt;</code></td>
      <td style={TableStyle.td}>現在のベースマップ（'osm', 'satellite'等）</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>layerStates</code></td>
      <td style={TableStyle.td}><code>useState&lt;Map&lt;string, LayerState&gt;&gt;</code></td>
      <td style={TableStyle.td}>各レイヤーの表示状態管理</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>darkMode</code></td>
      <td style={TableStyle.td}><code>useState&lt;boolean&gt;</code></td>
      <td style={TableStyle.td}>ダークモード有効フラグ</td>
    </tr>
  </tbody>
</table>

---

## パフォーマンス考慮事項

### 大規模データの扱い

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>形式</th>
      <th style={TableStyle.th}>用途</th>
      <th style={TableStyle.th}>推奨ファイルサイズ</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>GeoJSON</strong></td>
      <td style={TableStyle.td}>小規模区域（市区町村レベル）</td>
      <td style={TableStyle.td}>〜 5MB</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><strong>Vector Tiles (MVT)</strong></td>
      <td style={TableStyle.td}>中規模データ（都道府県レベル）</td>
      <td style={TableStyle.td}>5 - 100MB</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><strong>PMTiles</strong></td>
      <td style={TableStyle.td}>大規模データ（全国レベル）</td>
      <td style={TableStyle.td}>100MB+</td>
    </tr>
  </tbody>
</table>

---

## ストレージ キー一覧

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>キー</th>
      <th style={TableStyle.th}>ストレージ</th>
      <th style={TableStyle.th}>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>ui-settings</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>ダークモード、ベースマップ設定、タイムスタンプ</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>did-map-drawn-features</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>DrawingToolsで描画した図形のバックアップ</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>did-expanded-groups</code></td>
      <td style={TableStyle.td}>Local</td>
      <td style={TableStyle.td}>左サイドバーの都道府県グループの開閉状態</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>map-view-state-once</code></td>
      <td style={TableStyle.td}>Session</td>
      <td style={TableStyle.td}>ベースマップ切替時のリロード用ビュー位置保持</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>restriction-visible-ids</code></td>
      <td style={TableStyle.td}>Session</td>
      <td style={TableStyle.td}>表示中の制限区域レイヤーID一覧</td>
    </tr>
  </tbody>
</table>

---

## コンポーネント API

### DrawingTools

作図機能を一括提供するコンポーネントです。内部で MapboxDraw インスタンスを管理します。

**Path**: `src/components/DrawingTools.tsx`

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>Prop</th>
      <th style={TableStyle.th}>Type</th>
      <th style={TableStyle.th}>Default</th>
      <th style={TableStyle.th}>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>map</code></td>
      <td style={TableStyle.td}><code>maplibregl.Map</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}><strong>必須</strong> 初期化済みのマップインスタンス</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>mapLoaded</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>マップのロード完了フラグ</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>onFeaturesChange</code></td>
      <td style={TableStyle.td}><code>(features: DrawnFeature[]) =&gt; void</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}>図形が追加・編集・削除された時に発火</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>darkMode</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>UIをダークモードで表示</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code>embedded</code></td>
      <td style={TableStyle.td}><code>boolean</code></td>
      <td style={TableStyle.td}><code>false</code></td>
      <td style={TableStyle.td}>サイドバー埋め込み用のコンパクト表示</td>
    </tr>
    <tr>
      <td style={TableStyle.td}><code>onUndoRedoStateChange</code></td>
      <td style={TableStyle.td}><code>(state: UndoRedoState) =&gt; void</code></td>
      <td style={TableStyle.td}>-</td>
      <td style={TableStyle.td}>Undo/Redoボタンの活性状態を通知</td>
    </tr>
  </tbody>
</table>

---

## トラブルシューティング

### よくあるエラーと対処

**1. "Style is not loaded"**

```javascript
// ❌ エラーになる
const map = new maplibregl.Map({ ... });
map.addSource('src', { ... });  // スタイル未ロード

// ✅ 正しい
map.on('load', () => {
  map.addSource('src', { ... });
});
```

**2. "Source already exists"**

```javascript
// ❌ 2回追加するとエラー
map.addSource('src', { ... });
map.addSource('src', { ... });

// ✅ 存在チェック
if (!map.getSource('src')) {
  map.addSource('src', { ... });
}
```

**3. "Layer not found"**

```javascript
// ❌ 存在しないレイヤーを操作
map.setLayoutProperty('unknown-layer', 'visibility', 'none');

// ✅ 存在チェック
if (map.getLayer('my-layer')) {
  map.setLayoutProperty('my-layer', 'visibility', 'none');
}
```
