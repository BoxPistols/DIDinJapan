{/* 16_CollisionDetection.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="Learning/16_è¡çªæ¤œå‡º" />

export const TableStyle = {
  table: { width: '100%', borderCollapse: 'collapse', margin: '16px 0' },
  thead: { backgroundColor: 'rgba(74, 158, 255, 0.1)', borderBottom: '2px solid rgba(74, 158, 255, 0.3)' },
  th: { padding: '12px', textAlign: 'left', fontWeight: 600 },
  tr: { borderBottom: '1px solid rgba(255, 255, 255, 0.1)' },
  td: { padding: '12px' },
  code: { backgroundColor: 'rgba(255, 255, 255, 0.1)', padding: '2px 6px', borderRadius: '4px', fontFamily: 'monospace' }
}

# Collision Detectionï¼ˆè¡çªæ¤œå‡ºï¼‰

ãƒ‰ãƒ­ãƒ¼ãƒ³é£›è¡Œè¨ˆç”»ã«ãŠã„ã¦ã€Waypointãƒ»é£›è¡ŒçµŒè·¯ãƒ»é£›è¡Œç¯„å›²ãŒç¦æ­¢ã‚¨ãƒªã‚¢ã¨é‡è¤‡ã—ã¦ã„ãªã„ã‹ã‚’æ¤œå‡ºã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ã§ã™ã€‚

---

## 1. æ¦‚è¦

`src/lib/utils/collision.ts` ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>é–¢æ•°å</th>
      <th style={TableStyle.th}>ç”¨é€”</th>
      <th style={TableStyle.th}>è¨ˆç®—é‡</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>checkWaypointCollision</code></td>
      <td style={TableStyle.td}>å˜ä¸€Waypointã®ç¦æ­¢ã‚¨ãƒªã‚¢åˆ¤å®š</td>
      <td style={TableStyle.td}>O(n)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>checkWaypointCollisionOptimized</code></td>
      <td style={TableStyle.td}>ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ãŸé«˜é€Ÿåˆ¤å®š</td>
      <td style={TableStyle.td}>O(log n)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>checkPathCollision</code></td>
      <td style={TableStyle.td}>é£›è¡ŒçµŒè·¯ï¼ˆLineStringï¼‰ã®äº¤å·®åˆ¤å®š</td>
      <td style={TableStyle.td}>O(n)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>checkPolygonCollision</code></td>
      <td style={TableStyle.td}>é£›è¡Œç¯„å›²ï¼ˆPolygonï¼‰ã®é‡è¤‡åˆ¤å®š</td>
      <td style={TableStyle.td}>O(n)</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>createSpatialIndex</code></td>
      <td style={TableStyle.td}>RBushç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰</td>
      <td style={TableStyle.td}>O(n log n)</td>
    </tr>
  </tbody>
</table>

---

## 2. ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```bash
npm install @turf/turf rbush
```

- **@turf/turf**: GeoJSONç©ºé–“æ¼”ç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆPoint-in-Polygonã€Intersectç­‰ï¼‰
- **rbush**: é«˜é€ŸR-treeç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå¤§é‡ãƒãƒªã‚´ãƒ³ã®é«˜é€Ÿæ¤œç´¢ï¼‰

---

## 3. ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã¨è‰²å®šç¾©

è¡çªæ¤œå‡ºçµæœã¯ã€ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²ã¨æ·±åˆ»åº¦ã‚’è¿”ã—ã¾ã™ã€‚

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—</th>
      <th style={TableStyle.th}>è‰²</th>
      <th style={TableStyle.th}>ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰</th>
      <th style={TableStyle.th}>æ·±åˆ»åº¦</th>
      <th style={TableStyle.th}>èª¬æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>DID</code></td>
      <td style={TableStyle.td}>ğŸ”´ èµ¤</td>
      <td style={TableStyle.td}>#f44336</td>
      <td style={TableStyle.td}>WARNING</td>
      <td style={TableStyle.td}>äººå£é›†ä¸­åœ°åŒºï¼ˆè¨±å¯å–å¾—ã§é£›è¡Œå¯èƒ½ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>AIRPORT</code></td>
      <td style={TableStyle.td}>ğŸŸ£ ç´«</td>
      <td style={TableStyle.td}>#9C27B0</td>
      <td style={TableStyle.td}>DANGER</td>
      <td style={TableStyle.td}>ç©ºæ¸¯å‘¨è¾ºç©ºåŸŸï¼ˆåŸå‰‡é£›è¡Œç¦æ­¢ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>RED_ZONE</code></td>
      <td style={TableStyle.td}>ğŸŸ¥ æš—ã„èµ¤</td>
      <td style={TableStyle.td}>#b71c1c</td>
      <td style={TableStyle.td}>DANGER</td>
      <td style={TableStyle.td}>é£›è¡Œç¦æ­¢åŒºåŸŸï¼ˆå°å‹ç„¡äººæ©Ÿç­‰é£›è¡Œç¦æ­¢æ³•ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}><code style={TableStyle.code}>YELLOW_ZONE</code></td>
      <td style={TableStyle.td}>ğŸŸ¡ é»„è‰²</td>
      <td style={TableStyle.td}>#ffc107</td>
      <td style={TableStyle.td}>WARNING</td>
      <td style={TableStyle.td}>é£›è¡Œæ³¨æ„åŒºåŸŸï¼ˆäº‹å‰é€šå ±ãŒå¿…è¦ï¼‰</td>
    </tr>
  </tbody>
</table>

```typescript
import { ZONE_COLORS, ZONE_SEVERITY, CollisionType } from 'japan-drone-map'

// ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã®å®šç¾©
type CollisionType = 'DID' | 'AIRPORT' | 'RED_ZONE' | 'YELLOW_ZONE' | 'MILITARY' | 'PARK' | string

// è‰²å®šç¾©
const ZONE_COLORS = {
  DID: '#f44336',
  AIRPORT: '#9C27B0',
  RED_ZONE: '#b71c1c',
  YELLOW_ZONE: '#ffc107',
  DEFAULT: '#f44336'
}
```

---

## 4. Waypointè¡çªæ¤œå‡ºï¼ˆåŸºæœ¬ç‰ˆï¼‰

å˜ä¸€ã®Waypointåº§æ¨™ãŒç¦æ­¢ã‚¨ãƒªã‚¢å†…ã«ã‚ã‚‹ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚

### 4.1 ã‚·ã‚°ãƒãƒãƒ£

```typescript
function checkWaypointCollision(
  waypointCoords: [number, number],  // [çµŒåº¦, ç·¯åº¦]
  prohibitedAreas: FeatureCollection
): WaypointCollisionResult
```

### 4.2 æˆ»ã‚Šå€¤ã®æ§‹é€ 

```typescript
interface WaypointCollisionResult {
  isColliding: boolean          // è¡çªã—ã¦ã„ã‚‹ã‹
  collisionType: CollisionType | null  // ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—
  areaName?: string             // ã‚¨ãƒªã‚¢åï¼ˆä¾‹: "æ±äº¬éƒ½æ¸¯åŒº"ï¼‰
  severity: 'DANGER' | 'WARNING' | 'SAFE'
  uiColor: string               // UIè¡¨ç¤ºç”¨ã‚«ãƒ©ãƒ¼
  message: string               // æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
}
```

### 4.3 ä½¿ç”¨ä¾‹

```typescript
import { checkWaypointCollision } from 'japan-drone-map'

// ç¦æ­¢ã‚¨ãƒªã‚¢ã®GeoJSONã‚’æº–å‚™
const prohibitedAreas: FeatureCollection = {
  type: 'FeatureCollection',
  features: [
    {
      type: 'Feature',
      properties: {
        zoneType: 'DID',
        name: 'æ±äº¬éƒ½æ¸‹è°·åŒº'
      },
      geometry: {
        type: 'Polygon',
        coordinates: [[[139.69, 35.65], [139.72, 35.65], [139.72, 35.68], [139.69, 35.68], [139.69, 35.65]]]
      }
    }
  ]
}

// Waypointåº§æ¨™ï¼ˆæ¸‹è°·é§…ä»˜è¿‘ï¼‰
const waypoint: [number, number] = [139.7015, 35.6580]

const result = checkWaypointCollision(waypoint, prohibitedAreas)

if (result.isColliding) {
  console.log(`è­¦å‘Š: ${result.message}`)
  console.log(`ã‚¾ãƒ¼ãƒ³: ${result.collisionType}`)
  console.log(`æ·±åˆ»åº¦: ${result.severity}`)
  // => è­¦å‘Š: ã“ã®Waypointã¯æ±äº¬éƒ½æ¸‹è°·åŒºå†…ã«ã‚ã‚Šã¾ã™
  // => ã‚¾ãƒ¼ãƒ³: DID
  // => æ·±åˆ»åº¦: WARNING
}
```

### 4.4 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è©³ç´°

```
1. Waypointã®åº§æ¨™ã‹ã‚‰Turf.jsã®Pointã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
   point = turf.point([lng, lat])

2. FeatureCollectionå†…ã®å…¨Polygon/MultiPolygonã‚’ãƒ«ãƒ¼ãƒ—
   for each feature in prohibitedAreas.features:

3. turf.booleanPointInPolygon() ã§åŒ…å«åˆ¤å®š
   isInside = turf.booleanPointInPolygon(point, feature)

4. æœ€åˆã«ãƒ’ãƒƒãƒˆã—ãŸã‚¨ãƒªã‚¢ã®æƒ…å ±ã‚’è¿”å´
   if (isInside):
     return { isColliding: true, collisionType, areaName, ... }

5. ãƒ’ãƒƒãƒˆã—ãªã„å ´åˆã¯SAFEã‚’è¿”å´
   return { isColliding: false, severity: 'SAFE', ... }
```

---

## 5. Waypointè¡çªæ¤œå‡ºï¼ˆæœ€é©åŒ–ç‰ˆï¼‰

å¤§é‡ã®ç¦æ­¢ã‚¨ãƒªã‚¢ãŒã‚ã‚‹å ´åˆã€ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆR-treeï¼‰ã‚’ä½¿ã£ã¦é«˜é€Ÿã«åˆ¤å®šã—ã¾ã™ã€‚

### 5.1 ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰

```typescript
import { createSpatialIndex, checkWaypointCollisionOptimized } from 'japan-drone-map'

// åˆå›ã®ã¿: ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§‹ç¯‰ï¼ˆO(n log n)ï¼‰
const spatialIndex = createSpatialIndex(prohibitedAreas)

// ä»¥é™ã®åˆ¤å®šã¯ O(log n) ã§é«˜é€Ÿ
const result = checkWaypointCollisionOptimized(waypoint, spatialIndex)
```

### 5.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>ç¦æ­¢ã‚¨ãƒªã‚¢æ•°</th>
      <th style={TableStyle.th}>åŸºæœ¬ç‰ˆ</th>
      <th style={TableStyle.th}>æœ€é©åŒ–ç‰ˆ</th>
      <th style={TableStyle.th}>é«˜é€ŸåŒ–ç‡</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>100ä»¶</td>
      <td style={TableStyle.td}>~1ms</td>
      <td style={TableStyle.td}>~0.1ms</td>
      <td style={TableStyle.td}>10å€</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>1,000ä»¶</td>
      <td style={TableStyle.td}>~10ms</td>
      <td style={TableStyle.td}>~0.2ms</td>
      <td style={TableStyle.td}>50å€</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>10,000ä»¶</td>
      <td style={TableStyle.td}>~100ms</td>
      <td style={TableStyle.td}>~0.3ms</td>
      <td style={TableStyle.td}>333å€</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>å…¨å›½DIDï¼ˆ~50,000ä»¶ï¼‰</td>
      <td style={TableStyle.td}>~500ms</td>
      <td style={TableStyle.td}>~0.5ms</td>
      <td style={TableStyle.td}>1000å€</td>
    </tr>
  </tbody>
</table>

### 5.3 RBushã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

RBushï¼ˆR-tree Bulk loading using Sort-Tile-Recursiveï¼‰ã¯ã€ç©ºé–“ãƒ‡ãƒ¼ã‚¿ã®é«˜é€Ÿæ¤œç´¢ã«ç‰¹åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã™ã€‚

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            Root Node               â”‚
                    â”‚  BBox: [minX, minY, maxX, maxY]    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                       â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Leaf Node 1   â”‚     â”‚   Leaf Node 2   â”‚     â”‚   Leaf Node 3   â”‚
    â”‚ [Features...]   â”‚     â”‚ [Features...]   â”‚     â”‚ [Features...]   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**

1. æ¤œç´¢å¯¾è±¡ã®ç‚¹ï¼ˆWaypointï¼‰ã‚’Bounding Boxã¨ã—ã¦è¡¨ç¾
2. ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã‹ã‚‰å†å¸°çš„ã«ã€BBoxãŒé‡ãªã‚‹ãƒãƒ¼ãƒ‰ã®ã¿ã‚’æ¢ç´¢
3. ãƒªãƒ¼ãƒ•ãƒãƒ¼ãƒ‰ã«åˆ°é”ã—ãŸã‚‰ã€å®Ÿéš›ã®Polygonã¨ç‚¹ã®åŒ…å«åˆ¤å®šã‚’å®Ÿè¡Œ

---

## 6. é£›è¡ŒçµŒè·¯ã®äº¤å·®åˆ¤å®š

é£›è¡ŒçµŒè·¯ï¼ˆLineStringï¼‰ãŒç¦æ­¢ã‚¨ãƒªã‚¢ã¨äº¤å·®ã™ã‚‹ã‹ã‚’æ¤œå‡ºã—ã¾ã™ã€‚

### 6.1 ã‚·ã‚°ãƒãƒãƒ£

```typescript
function checkPathCollision(
  pathCoords: Position[],        // [[lng1, lat1], [lng2, lat2], ...]
  prohibitedAreas: FeatureCollection
): PathCollisionResult
```

### 6.2 æˆ»ã‚Šå€¤ã®æ§‹é€ 

```typescript
interface PathCollisionResult {
  isColliding: boolean
  intersectionPoints: Position[]  // äº¤å·®ç‚¹ã®åº§æ¨™ãƒªã‚¹ãƒˆ
  severity: 'DANGER' | 'WARNING' | 'SAFE'
  message: string
}
```

### 6.3 ä½¿ç”¨ä¾‹

```typescript
import { checkPathCollision } from 'japan-drone-map'

// é£›è¡ŒçµŒè·¯: 2ç‚¹é–“ã®ç›´ç·š
const flightPath: Position[] = [
  [139.70, 35.65],  // å‡ºç™ºç‚¹
  [139.75, 35.70]   // åˆ°ç€ç‚¹
]

const result = checkPathCollision(flightPath, prohibitedAreas)

if (result.isColliding) {
  console.log(`è­¦å‘Š: ${result.message}`)
  console.log(`äº¤å·®ç‚¹æ•°: ${result.intersectionPoints.length}`)
  // => è­¦å‘Š: é£›è¡ŒçµŒè·¯ãŒç¦æ­¢ã‚¨ãƒªã‚¢ã‚’2ç®‡æ‰€ã§é€šé
}
```

### 6.4 äº¤å·®åˆ¤å®šã®å¯è¦–åŒ–

```
       ç¦æ­¢ã‚¨ãƒªã‚¢ (Polygon)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        â”‚
    â”‚    Ã—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Ã—   â”‚  â† äº¤å·®ç‚¹ 2ç®‡æ‰€
    â”‚    â–²               â–²   â”‚
    â”‚    â”‚               â”‚   â”‚
â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€  é£›è¡ŒçµŒè·¯ (LineString)
    â”‚    â”‚               â”‚   â”‚
    â”‚    å‡ºç™ºç‚¹          åˆ°ç€ç‚¹â”‚
    â”‚                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. é£›è¡Œç¯„å›²ã®é‡è¤‡åˆ¤å®š

é£›è¡Œç¯„å›²ï¼ˆPolygonï¼‰ãŒç¦æ­¢ã‚¨ãƒªã‚¢ã¨é‡è¤‡ã™ã‚‹ã‹ã‚’æ¤œå‡ºã—ã¾ã™ã€‚

### 7.1 ã‚·ã‚°ãƒãƒãƒ£

```typescript
function checkPolygonCollision(
  polygonCoords: Position[][],   // [[[lng, lat], ...]]  å¤–å‘¨ãƒªãƒ³ã‚°
  prohibitedAreas: FeatureCollection
): PolygonCollisionResult
```

### 7.2 æˆ»ã‚Šå€¤ã®æ§‹é€ 

```typescript
interface PolygonCollisionResult {
  isColliding: boolean
  overlapArea: number       // é‡è¤‡é¢ç©ï¼ˆå¹³æ–¹ãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
  overlapRatio: number      // é‡è¤‡å‰²åˆï¼ˆ0.0 ~ 1.0ï¼‰
  severity: 'DANGER' | 'WARNING' | 'SAFE'
  message: string
}
```

### 7.3 æ·±åˆ»åº¦ã®åˆ¤å®šåŸºæº–

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>é‡è¤‡å‰²åˆ</th>
      <th style={TableStyle.th}>æ·±åˆ»åº¦</th>
      <th style={TableStyle.th}>èª¬æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>0%</td>
      <td style={TableStyle.td}>SAFE</td>
      <td style={TableStyle.td}>é‡è¤‡ãªã— - é£›è¡Œå¯èƒ½</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>0% ~ 20%</td>
      <td style={TableStyle.td}>WARNING</td>
      <td style={TableStyle.td}>ä¸€éƒ¨é‡è¤‡ - çµŒè·¯å¤‰æ›´æ¨å¥¨</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>20%ä»¥ä¸Š</td>
      <td style={TableStyle.td}>DANGER</td>
      <td style={TableStyle.td}>å¤§å¹…é‡è¤‡ - é£›è¡Œè¨ˆç”»è¦‹ç›´ã—å¿…è¦</td>
    </tr>
  </tbody>
</table>

### 7.4 ä½¿ç”¨ä¾‹

```typescript
import { checkPolygonCollision } from 'japan-drone-map'

// é£›è¡Œç¯„å›²: å››è§’å½¢ã‚¨ãƒªã‚¢
const flightArea: Position[][] = [[
  [139.70, 35.65],
  [139.72, 35.65],
  [139.72, 35.67],
  [139.70, 35.67],
  [139.70, 35.65]  // é–‰ã˜ã‚‹ï¼ˆæœ€åˆã¨åŒã˜åº§æ¨™ï¼‰
]]

const result = checkPolygonCollision(flightArea, prohibitedAreas)

if (result.isColliding) {
  console.log(`è­¦å‘Š: ${result.message}`)
  console.log(`é‡è¤‡é¢ç©: ${result.overlapArea.toFixed(0)} mÂ²`)
  console.log(`é‡è¤‡å‰²åˆ: ${(result.overlapRatio * 100).toFixed(1)}%`)
}
```

---

## 8. Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 8.1 useRefã‚’ä½¿ã£ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
import { useRef, useMemo, useCallback } from 'react'
import { createSpatialIndex, checkWaypointCollisionOptimized } from 'japan-drone-map'

function FlightPlanner() {
  // GeoJSONã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–“ã§ä¿æŒï¼‰
  const didGeoJSONCacheRef = useRef<FeatureCollection | null>(null)
  const restrictionGeoJSONCacheRef = useRef<FeatureCollection | null>(null)

  // ç¦æ­¢ã‚¨ãƒªã‚¢ã‚’çµ±åˆï¼ˆä¾å­˜ãŒå¤‰ã‚ã£ãŸã¨ãã®ã¿å†è¨ˆç®—ï¼‰
  const prohibitedAreas = useMemo(() => {
    const features = []

    // DIDãƒ‡ãƒ¼ã‚¿
    if (didGeoJSONCacheRef.current) {
      features.push(...didGeoJSONCacheRef.current.features.map(f => ({
        ...f,
        properties: { ...f.properties, zoneType: 'DID' }
      })))
    }

    // ç©ºæ¸¯å‘¨è¾ºç©ºåŸŸ
    if (restrictionGeoJSONCacheRef.current) {
      features.push(...restrictionGeoJSONCacheRef.current.features.map(f => ({
        ...f,
        properties: { ...f.properties, zoneType: 'AIRPORT' }
      })))
    }

    return { type: 'FeatureCollection', features }
  }, [didGeoJSONCacheRef.current, restrictionGeoJSONCacheRef.current])

  // ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆç¦æ­¢ã‚¨ãƒªã‚¢ãŒå¤‰ã‚ã£ãŸã‚‰å†æ§‹ç¯‰ï¼‰
  const spatialIndex = useMemo(() => {
    if (prohibitedAreas.features.length === 0) return null
    return createSpatialIndex(prohibitedAreas)
  }, [prohibitedAreas])

  // Waypointè¿½åŠ æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
  const handleWaypointAdd = useCallback((coords: [number, number]) => {
    if (spatialIndex) {
      const result = checkWaypointCollisionOptimized(coords, spatialIndex)
      if (result.isColliding) {
        showWarning(result.message)
      }
    }
  }, [spatialIndex])

  return (/* UI */)
}
```

---

## 9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 9.1 ç„¡åŠ¹ãªå…¥åŠ›ã¸ã®å¯¾å¿œ

```typescript
// ãƒãƒªã‚´ãƒ³ã®åº§æ¨™ãŒä¸ååˆ†ãªå ´åˆ
const result = checkPolygonCollision([[]], prohibitedAreas)
// => { isColliding: false, message: 'åº§æ¨™ãŒä¸ååˆ†ã§ã™' }

// 3ç‚¹æœªæº€ï¼ˆãƒãƒªã‚´ãƒ³ã«ã¯æœ€ä½4ç‚¹å¿…è¦ï¼‰
const result = checkPolygonCollision([[[0, 0], [1, 1]]], prohibitedAreas)
// => { isColliding: false, message: 'åº§æ¨™ãŒä¸ååˆ†ã§ã™' }

// è‡ªå·±äº¤å·®ãªã©ã®ç„¡åŠ¹ãªã‚¸ã‚ªãƒ¡ãƒˆãƒª
const result = checkPolygonCollision(invalidCoords, prohibitedAreas)
// => { isColliding: false, message: 'ç„¡åŠ¹ãªãƒãƒªã‚´ãƒ³å½¢çŠ¶' }
```

### 9.2 GeoJSONãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å–å¾—å„ªå…ˆé †ä½

ã‚¾ãƒ¼ãƒ³ã‚¿ã‚¤ãƒ—ã¯ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§å–å¾—ã•ã‚Œã¾ã™ï¼š

1. `feature.properties.zoneType`ï¼ˆæ¨å¥¨ï¼‰
2. `feature.properties.type`ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `'DID'`

---

## 10. ãƒ†ã‚¹ãƒˆ

### 10.1 åŸºæœ¬ãƒ†ã‚¹ãƒˆ

```typescript
import { describe, it, expect } from 'vitest'
import { checkWaypointCollision, checkPathCollision, checkPolygonCollision } from './collision'

describe('Collision Detection', () => {
  const testArea: FeatureCollection = {
    type: 'FeatureCollection',
    features: [{
      type: 'Feature',
      properties: { zoneType: 'DID', name: 'ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢' },
      geometry: {
        type: 'Polygon',
        coordinates: [[[0, 0], [1, 0], [1, 1], [0, 1], [0, 0]]]
      }
    }]
  }

  it('ã‚¨ãƒªã‚¢å†…ã®Waypointã‚’æ¤œå‡ºã™ã‚‹', () => {
    const result = checkWaypointCollision([0.5, 0.5], testArea)
    expect(result.isColliding).toBe(true)
    expect(result.collisionType).toBe('DID')
  })

  it('ã‚¨ãƒªã‚¢å¤–ã®Waypointã¯SAFE', () => {
    const result = checkWaypointCollision([2, 2], testArea)
    expect(result.isColliding).toBe(false)
    expect(result.severity).toBe('SAFE')
  })

  it('çµŒè·¯ã®äº¤å·®ã‚’æ¤œå‡ºã™ã‚‹', () => {
    const result = checkPathCollision([[-1, 0.5], [2, 0.5]], testArea)
    expect(result.isColliding).toBe(true)
    expect(result.intersectionPoints.length).toBe(2)
  })
})
```

### 10.2 å®Ÿåº§æ¨™ã‚’ä½¿ã£ãŸå†ç¾æ€§ãƒ†ã‚¹ãƒˆ

```typescript
describe('å®Ÿåº§æ¨™ãƒ†ã‚¹ãƒˆ', () => {
  const tokyoStationArea = createTestAreaAroundTokyoStation()

  it('æ±äº¬é§…ä»˜è¿‘ã®Waypointã¯DIDå†…ã¨åˆ¤å®š', () => {
    const tokyoStation: [number, number] = [139.7671, 35.6812]
    const result = checkWaypointCollision(tokyoStation, tokyoStationArea)
    expect(result.isColliding).toBe(true)
    expect(result.areaName).toBe('æ±äº¬é§…å‘¨è¾ºDID')
  })
})
```

---

## 11. å‚è€ƒæ–‡çŒ®ãƒ»å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Turf.js å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://turfjs.org/) - GeoJSONç©ºé–“æ¼”ç®—ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [Turf.js booleanPointInPolygon](https://turfjs.org/docs/api/booleanPointInPolygon) - ç‚¹ã®åŒ…å«åˆ¤å®š
- [Turf.js lineIntersect](https://turfjs.org/docs/api/lineIntersect) - ãƒ©ã‚¤ãƒ³äº¤å·®åˆ¤å®š
- [Turf.js intersect](https://turfjs.org/docs/api/intersect) - ãƒãƒªã‚´ãƒ³äº¤å·®è¨ˆç®—
- [RBush GitHub](https://github.com/mourner/rbush) - é«˜é€ŸR-treeç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

### GeoJSONä»•æ§˜

- [RFC 7946 - The GeoJSON Format](https://datatracker.ietf.org/doc/html/rfc7946) - GeoJSONå…¬å¼ä»•æ§˜
- [GeoJSON.io](https://geojson.io/) - GeoJSONã‚¨ãƒ‡ã‚£ã‚¿ãƒ»ãƒ“ãƒ¥ãƒ¼ã‚¢

### ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

- [R-tree (Wikipedia)](https://en.wikipedia.org/wiki/R-tree) - R-treeãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®è§£èª¬
- [Point in Polygon Algorithm](https://en.wikipedia.org/wiki/Point_in_polygon) - Ray Castingæ³•ã®è§£èª¬

### ãƒ‰ãƒ­ãƒ¼ãƒ³é£›è¡Œè¦åˆ¶é–¢é€£

- [å›½åœŸäº¤é€šçœ ç„¡äººèˆªç©ºæ©Ÿã®é£›è¡Œãƒ«ãƒ¼ãƒ«](https://www.mlit.go.jp/koku/koku_tk10_000003.html) - èˆªç©ºæ³•ã«åŸºã¥ãé£›è¡Œãƒ«ãƒ¼ãƒ«
- [DIPS 2.0ï¼ˆãƒ‰ãƒ­ãƒ¼ãƒ³æƒ…å ±åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ ï¼‰](https://www.ossportal.dips.mlit.go.jp/) - é£›è¡Œè¨±å¯ç”³è«‹ã‚·ã‚¹ãƒ†ãƒ 
- [å›½åœŸåœ°ç†é™¢ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«](https://maps.gsi.go.jp/development/ichiran.html) - ç©ºæ¸¯å‘¨è¾ºç©ºåŸŸã‚¿ã‚¤ãƒ«ç­‰
