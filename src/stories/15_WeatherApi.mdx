{/* 15_WeatherApi.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="API/15_å¤©æ°—äºˆå ±APIä»•æ§˜" />

# å¤©æ°—äºˆå ±APIä»•æ§˜æ›¸

æœ¬ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯**2ã¤ã®å¤©æ°—é–¢é€£ã‚·ã‚¹ãƒ†ãƒ **ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

| ã‚·ã‚¹ãƒ†ãƒ  | ç”¨é€” | API | ãƒ•ã‚¡ã‚¤ãƒ« |
|----------|------|-----|----------|
| **å¤©æ°—äºˆå ±è¡¨ç¤º** | éƒ½é“åºœçœŒåˆ¥å¤©æ°—äºˆå ±UI | Open-Meteo | `weatherApi.ts` |
| **ãƒ‰ãƒ­ãƒ¼ãƒ³é‹ç”¨å®‰å…¨** | é£›è¡Œå¯å¦åˆ¤å®š | JMA Mesh | `jmaMesh.ts` |

---

## 1. å¤©æ°—äºˆå ±è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ  (Open-Meteo)

åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§éƒ½é“åºœçœŒã®å¤©æ°—äºˆå ±ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã€‚

### 1-1. æ¦‚è¦

```
API: Open-Meteo API
URL: https://api.open-meteo.com/v1/forecast
æ–™é‡‘: å®Œå…¨ç„¡æ–™
èªè¨¼: ä¸è¦
åˆ¶é™: 10,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼ˆéå•†ç”¨ï¼‰
```

### 1-2. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

| ã‚­ãƒ¼ | æ©Ÿèƒ½ |
|:---:|:---|
| `W` | å¤©æ°—äºˆå ±ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ãƒˆã‚°ãƒ« |
| `C` | é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ã®ãƒˆã‚°ãƒ« |
| `ESC` | ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ»ãƒ‘ãƒãƒ«ã‚’é †ç•ªã«é–‰ã˜ã‚‹ |

### 1-3. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/
â”œâ”€â”€ lib/services/
â”‚   â”œâ”€â”€ weatherApi.ts      # Open-Meteo APIé€£æº
â”‚   â””â”€â”€ rainViewer.ts      # RainViewer APIé€£æºï¼ˆé›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼‰
â””â”€â”€ components/weather/
    â””â”€â”€ WeatherForecastPanel.tsx  # è©³ç´°äºˆå ±ãƒ‘ãƒãƒ«
```

### 1-4. weatherApi.ts ä¸»è¦é–¢æ•°

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `fetchPrefectureWeather(lat, lng)` | åº§æ¨™ã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾— |
| `getPrefectureForecast(prefectureId)` | éƒ½é“åºœçœŒIDã‹ã‚‰å¤©æ°—å–å¾— |
| `findNearestPrefecture(lat, lng)` | æœ€å¯„ã‚Šã®éƒ½é“åºœçœŒã‚’æ¤œç´¢ |
| `getWeatherDescription(code)` | å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ™ãƒ«ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ› |
| `formatHourlyTime(time)` | æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ |
| `formatDailyDate(date)` | æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ |
| `getAllRegions()` | å…¨åœ°æ–¹åãƒªã‚¹ãƒˆå–å¾— |
| `getPrefecturesByRegion(region)` | åœ°æ–¹åˆ¥éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ |

### 1-5. éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿

å…¨47éƒ½é“åºœçœŒã®çœŒåºæ‰€åœ¨åœ°åº§æ¨™ã‚’ `JAPAN_PREFECTURES` é…åˆ—ã§ç®¡ç†ã€‚

```typescript
export const JAPAN_PREFECTURES = [
  { id: 'hokkaido', name: 'åŒ—æµ·é“', capital: 'æœ­å¹Œ', lat: 43.06, lng: 141.35, region: 'åŒ—æµ·é“' },
  { id: 'aomori', name: 'é’æ£®çœŒ', capital: 'é’æ£®', lat: 40.82, lng: 140.74, region: 'æ±åŒ—' },
  { id: 'iwate', name: 'å²©æ‰‹çœŒ', capital: 'ç››å²¡', lat: 39.70, lng: 141.15, region: 'æ±åŒ—' },
  // ... å…¨47éƒ½é“åºœçœŒ
]

// åœ°æ–¹åŒºåˆ†
const REGIONS = ['åŒ—æµ·é“', 'æ±åŒ—', 'é–¢æ±', 'ä¸­éƒ¨', 'è¿‘ç•¿', 'ä¸­å›½', 'å››å›½', 'ä¹å·ãƒ»æ²–ç¸„']
```

### 1-6. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLæ§‹ç¯‰
const url = `https://api.open-meteo.com/v1/forecast?` +
  `latitude=${lat}&longitude=${lng}` +
  `&current=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m` +
  `&hourly=temperature_2m,weather_code,precipitation` +
  `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum` +
  `&timezone=Asia%2FTokyo`
```

### 1-7. APIãƒ¬ã‚¹ãƒãƒ³ã‚¹

```json
{
  "current": {
    "temperature_2m": 5.2,
    "relative_humidity_2m": 72,
    "precipitation": 0,
    "weather_code": 3,
    "wind_speed_10m": 7.4
  },
  "hourly": {
    "time": ["2026-01-20T00:00", "2026-01-20T01:00", "..."],
    "temperature_2m": [5.2, 4.8, "..."],
    "weather_code": [3, 3, "..."],
    "precipitation": [0, 0.1, "..."]
  },
  "daily": {
    "time": ["2026-01-20", "2026-01-21", "..."],
    "weather_code": [3, 71, "..."],
    "temperature_2m_max": [8, 5, "..."],
    "temperature_2m_min": [-2, -3, "..."],
    "precipitation_sum": [0.1, 2.5, "..."]
  }
}
```

### 1-8. WMOå¤©æ°—ã‚³ãƒ¼ãƒ‰å¯¾å¿œè¡¨

| ã‚³ãƒ¼ãƒ‰ | å¤©æ°— | ã‚¢ã‚¤ã‚³ãƒ³ |
|:------:|------|:--------:|
| 0 | å¿«æ™´ | â˜€ï¸ |
| 1 | æ™´ã‚Œ | ğŸŒ¤ï¸ |
| 2 | ä¸€éƒ¨æ›‡ã‚Š | â›… |
| 3 | æ›‡ã‚Š | ğŸŒ¥ï¸ |
| 45, 48 | éœ§ | ğŸŒ«ï¸ |
| 51, 53, 55 | éœ§é›¨ | ğŸŒ¦ï¸ |
| 61, 63, 65 | é›¨ | ğŸŒ§ï¸ |
| 66, 67 | å‡é›¨ | ğŸŒ§ï¸ |
| 71, 73, 75 | é›ª | â„ï¸ |
| 77 | éœ§é›ª | ğŸŒ¨ï¸ |
| 80, 81, 82 | ã«ã‚ã‹é›¨ | ğŸŒ§ï¸ |
| 85, 86 | ã«ã‚ã‹é›ª | ğŸŒ¨ï¸ |
| 95, 96, 99 | é›·é›¨ | â›ˆï¸ |

### 1-9. ä½¿ç”¨ä¾‹

```tsx
import {
  fetchPrefectureWeather,
  findNearestPrefecture,
  getWeatherDescription
} from 'japan-drone-map'

// åœ°å›³ã‚¯ãƒªãƒƒã‚¯æ™‚
async function handleMapClick(lat: number, lng: number) {
  // æœ€å¯„ã‚Šã®éƒ½é“åºœçœŒã‚’æ¤œç´¢
  const prefecture = findNearestPrefecture(lat, lng)

  // å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—
  const weather = await fetchPrefectureWeather(prefecture.lat, prefecture.lng)

  // å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒ©ãƒ™ãƒ«å–å¾—
  const { icon, label } = getWeatherDescription(weather.current.weather_code)

  console.log(`${prefecture.name}: ${icon} ${weather.current.temperature_2m}Â°C ${label}`)
}
```

---

## 2. é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ (RainViewer)

### 2-1. æ¦‚è¦

```
API: RainViewer API
URL: https://api.rainviewer.com/public/weather-maps.json
æ–™é‡‘: å®Œå…¨ç„¡æ–™
èªè¨¼: ä¸è¦
æ›´æ–°: 5åˆ†ã”ã¨
```

### 2-2. rainViewer.ts ä¸»è¦é–¢æ•°

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `getAvailableFrames()` | åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å–å¾— |
| `buildTileUrl(path)` | XYZã‚¿ã‚¤ãƒ«URLç”Ÿæˆ |

### 2-3. ä½¿ç”¨ä¾‹

```tsx
import { RainViewerService } from 'japan-drone-map'

// é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
const data = await RainViewerService.getAvailableFrames()
const latestPath = data.radar.past[data.radar.past.length - 1].path

// MapLibreãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨URL
const tileUrl = RainViewerService.buildTileUrl(latestPath)
// => "https://tilecache.rainviewer.com/v2/radar/{path}/256/{z}/{x}/{y}/2/1_1.png"
```

---

## 3. ãƒ‰ãƒ­ãƒ¼ãƒ³é‹ç”¨å®‰å…¨ã‚·ã‚¹ãƒ†ãƒ  (JMA Mesh)

é£›è¡Œå¯å¦ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã®æ°—è±¡ãƒ»é€šä¿¡ãƒ»æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ãŸã‚·ã‚¹ãƒ†ãƒ ã€‚

### 3-1. æ¦‚è¦

```
ç›®çš„: ãƒ‰ãƒ­ãƒ¼ãƒ³é£›è¡Œã®å®‰å…¨æ€§åˆ¤å®š
ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:
  - æ°—è±¡åºãƒ¡ãƒƒã‚·ãƒ¥APIï¼ˆé¢¨é€Ÿãƒ»é™æ°´ç¢ºç‡ï¼‰
  - Sunrise-Sunset.orgï¼ˆæ°‘é–“è–„æ˜æ™‚é–“ï¼‰
  - LTEã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆé€šä¿¡ç¢ºä¿ï¼‰
```

### 3-2. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/lib/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ jmaMesh.ts           # æ°—è±¡åºãƒ¡ãƒƒã‚·ãƒ¥API
â”‚   â”œâ”€â”€ sunriseSunset.ts     # æ—¥æ²¡æ™‚åˆ»API
â”‚   â””â”€â”€ networkCoverage.ts   # LTEã‚«ãƒãƒ¬ãƒƒã‚¸
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useWeatherMesh.ts    # æ°—è±¡ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useFlightWindow.ts   # é£›è¡Œå¯èƒ½æ™‚é–“å¸¯
â”‚   â”œâ”€â”€ useNetworkCoverage.ts # é€šä¿¡çŠ¶æ³
â”‚   â””â”€â”€ useOperationSafety.ts # çµ±åˆå®‰å…¨åˆ¤å®š
â””â”€â”€ utils/
    â””â”€â”€ meshCodeConverter.ts  # ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰å¤‰æ›
```

### 3-3. é£›è¡Œå®‰å…¨åˆ¤å®šãƒ«ãƒ¼ãƒ«

```typescript
// useOperationSafety ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
canFly = true
  && windSpeed < 10      // é¢¨é€Ÿ10m/sæœªæº€
  && precipitation <= 50 // é™æ°´ç¢ºç‡50%ä»¥ä¸‹
  && hasLTE              // LTEé€šä¿¡åœå†…
  && isDaylight          // æ°‘é–“è–„æ˜æ™‚é–“å†…
```

### 3-4. å®‰å…¨ãƒ¬ãƒ™ãƒ«å®šç¾©

| ãƒ¬ãƒ™ãƒ« | è‰² | èª¬æ˜ |
|--------|-----|------|
| `safe` | ğŸŸ¢ ç·‘ | å®‰å…¨ã«é£›è¡Œå¯èƒ½ |
| `caution` | ğŸŸ¡ é»„ | æ³¨æ„ãŒå¿…è¦ |
| `warning` | ğŸŸ  æ©™ | è­¦å‘Šï¼ˆæ¡ä»¶æ‚ªåŒ–ï¼‰ |
| `danger` | ğŸ”´ èµ¤ | å±é™ºï¼ˆé£›è¡Œéæ¨å¥¨ï¼‰ |
| `prohibited` | â›” æ¿ƒèµ¤ | é£›è¡Œç¦æ­¢ |

### 3-5. é¢¨é€ŸåŸºæº–

| é¢¨é€Ÿ (m/s) | ãƒ¬ãƒ™ãƒ« | åˆ¤å®š |
|:---:|:---:|:---|
| 0 - 2 | `safe` | å®‰å…¨ï¼ˆè‰¯å¥½ï¼‰ |
| 2 - 5 | `caution` | æ³¨æ„ï¼ˆé£›è¡Œå¯èƒ½ï¼‰ |
| 5 - 10 | `warning` | è­¦å‘Šï¼ˆæ“ç¸¦é›£åŒ–ï¼‰ |
| 10+ | `danger` | å±é™ºï¼ˆé£›è¡Œä¸å¯ï¼‰ |

### 3-6. useOperationSafety ãƒ•ãƒƒã‚¯

```typescript
import { useOperationSafety, getSafetyLevelColor } from 'japan-drone-map'

function FlightSafetyCheck({ lat, lng, meshCode }) {
  const safety = useOperationSafety(lat, lng, meshCode)

  if (safety.loading) return <div>å®‰å…¨ç¢ºèªä¸­...</div>

  return (
    <div style={{ backgroundColor: getSafetyLevelColor(safety.safetyLevel) }}>
      {safety.canFly ? (
        <span>âœ“ é£›è¡Œå¯èƒ½</span>
      ) : (
        <div>
          <span>âœ— é£›è¡Œä¸å¯</span>
          <ul>
            {safety.reasons.map((r, i) => (
              <li key={i}>{r.message}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  )
}
```

### 3-7. OperationSafetyResult å‹

```typescript
interface OperationSafetyResult {
  canFly: boolean
  reasons: SafetyReason[]
  safetyLevel: SafetyLevel
  nextSafeWindow: Date | null
  loading: boolean
  error: string | null
  refetch: () => Promise<void>

  // ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
  weatherData?: {
    windSpeed?: number
    windDirection?: number
    precipitationProbability?: number
    temperature?: number
  }
  networkData?: {
    hasLTE: boolean
    signalStrength: string
  }
  flightWindowData?: {
    flightAllowedNow: boolean
    minutesRemaining: number | null
  }
}
```

---

## 4. ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰å¤‰æ›

æ°—è±¡åºãƒ‡ãƒ¼ã‚¿ã¯ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã€ã§åœ°åŸŸã‚’è­˜åˆ¥ã—ã¾ã™ã€‚

### 4-1. meshCodeConverter.ts

```typescript
import {
  latLngToMeshCode,
  meshCodeToLatLng,
  getSurroundingMeshCodes
} from 'japan-drone-map'

// åº§æ¨™ â†’ ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰
const meshCode = latLngToMeshCode(35.6895, 139.6917)
// => "53393599"

// ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ â†’ åº§æ¨™ï¼ˆä¸­å¿ƒç‚¹ï¼‰
const center = meshCodeToLatLng("53393599")
// => { lat: 35.6895833, lng: 139.6916666 }

// å‘¨è¾ºãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰å–å¾—
const surrounding = getSurroundingMeshCodes("53393599")
// => ["53393589", "53393598", "53393599", ...]
```

---

## 5. æ—¥æ²¡æ™‚åˆ»ãƒ»æ°‘é–“è–„æ˜ (Sunrise-Sunset)

### 5-1. APIä»•æ§˜

```
API: Sunrise-Sunset.org
URL: https://api.sunrise-sunset.org/json
æ–™é‡‘: å®Œå…¨ç„¡æ–™
èªè¨¼: ä¸è¦
```

### 5-2. useFlightWindow ãƒ•ãƒƒã‚¯

```typescript
import { useFlightWindow } from 'japan-drone-map'

function DaylightInfo({ lat, lng }) {
  const flight = useFlightWindow(lat, lng)

  return (
    <div>
      <p>æ—¥ã®å‡º: {flight.sunrise?.toLocaleTimeString()}</p>
      <p>æ—¥æ²¡: {flight.sunset?.toLocaleTimeString()}</p>
      <p>æ°‘é–“è–„æ˜çµ‚äº†: {flight.civilTwilightEnd?.toLocaleTimeString()}</p>
      <p>é£›è¡Œå¯èƒ½: {flight.flightAllowedNow ? 'ã¯ã„' : 'ã„ã„ãˆ'}</p>
      {flight.minutesRemaining && (
        <p>æ®‹ã‚Šæ™‚é–“: {flight.minutesRemaining}åˆ†</p>
      )}
    </div>
  )
}
```

### 5-3. MLITè¦åˆ¶

```
â–  ç„¡äººèˆªç©ºæ©Ÿã®é£›è¡Œç¦æ­¢æ™‚é–“å¸¯
- æ°‘é–“è–„æ˜æ™‚é–“çµ‚äº†å¾Œï¼ˆå¤œé–“ï¼‰ã®ãƒ‰ãƒ­ãƒ¼ãƒ³é£›è¡Œç¦æ­¢
- ä¾‹å¤–: ç…§æ˜è¨­å‚™ã®ã‚ã‚‹ã‚¨ãƒªã‚¢ã§è¨±å¯ç”³è«‹ã•ã‚ŒãŸå ´åˆã®ã¿

â–  æ°‘é–“è–„æ˜æ™‚é–“ï¼ˆCivil Twilightï¼‰ã¨ã¯
- æ—¥æ²¡å¾Œã€å¤ªé™½ã®ä¸­å¿ƒãŒåœ°å¹³ç·šä¸‹6Â°ã«é”ã™ã‚‹ã¾ã§ã®æ™‚é–“
- ã“ã®é–“ã¯è‡ªç„¶å…‰ã§ååˆ†ãªè¦–èªæ€§ãŒã‚ã‚‹
```

---

## 6. å‚è€ƒãƒªãƒ³ã‚¯

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Open-Meteo API](https://open-meteo.com/en/docs)
- [RainViewer API](https://www.rainviewer.com/api.html)
- [Sunrise-Sunset API](https://sunrise-sunset.org/api)
- [æ°—è±¡åºãƒ¡ãƒƒã‚·ãƒ¥æƒ…å ±](https://www.jma.go.jp/bosai/mesh/)

### æ³•è¦åˆ¶
- [å›½åœŸäº¤é€šçœ ç„¡äººèˆªç©ºæ©Ÿã®é£›è¡Œè¨±å¯](https://www.mlit.go.jp/koku/koku_tk10_000003.html)
- [WMO Weather Codes](https://open-meteo.com/en/docs#weathervariables)
