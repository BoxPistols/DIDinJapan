{/* 17_PerformanceOptimization.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="Learning/17_ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–" />

export const TableStyle = {
  table: { width: '100%', borderCollapse: 'collapse', margin: '16px 0' },
  thead: { backgroundColor: 'rgba(74, 158, 255, 0.1)', borderBottom: '2px solid rgba(74, 158, 255, 0.3)' },
  th: { padding: '12px', textAlign: 'left', fontWeight: 600 },
  tr: { borderBottom: '1px solid rgba(255, 255, 255, 0.1)' },
  td: { padding: '12px' },
  code: { backgroundColor: 'rgba(255, 255, 255, 0.1)', padding: '2px 6px', borderRadius: '4px', fontFamily: 'monospace' }
}

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥

DIDï¼ˆäººå£é›†ä¸­åœ°åŒºï¼‰ã€ç©ºåŸŸåˆ¶é™ã€å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãªã©**å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ**ã‚’æ‰±ã†ãƒ‰ãƒ­ãƒ¼ãƒ³é£›è¡Œè¨ˆç”»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æ‰‹æ³•ã§ã™ã€‚

---

## 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª²é¡Œã¨æ”¹å–„æ¦‚è¦

### å•é¡Œç‚¹ï¼ˆæ”¹å–„å‰ï¼‰

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>å•é¡Œ</th>
      <th style={TableStyle.th}>åŸå› </th>
      <th style={TableStyle.th}>ç—‡çŠ¶</th>
      <th style={TableStyle.th}>å½±éŸ¿åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ¡ãƒ¢ãƒªé‡è¤‡</td>
      <td style={TableStyle.td}>GeoJSONãƒ‡ãƒ¼ã‚¿ãŒ3ç®‡æ‰€ã«å­˜åœ¨</td>
      <td style={TableStyle.td}>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ ~117MBï¼ˆDIDå…¨å›½ï¼‰</td>
      <td style={TableStyle.td}>ğŸ”´ High</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>mousemove éåº¦å®Ÿè¡Œ</td>
      <td style={TableStyle.td}>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—</td>
      <td style={TableStyle.td}>æ¯ãƒ”ã‚¯ã‚»ãƒ«ç§»å‹•ã§JavaScriptå®Ÿè¡Œ</td>
      <td style={TableStyle.td}>ğŸ”´ High</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢</td>
      <td style={TableStyle.td}>queryRenderedFeaturesãŒ94å€‹å…¨ã¦æ¤œç´¢</td>
      <td style={TableStyle.td}>ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºãŒé…å»¶</td>
      <td style={TableStyle.td}>ğŸŸ  Medium</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>åŒæœŸçš„ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ </td>
      <td style={TableStyle.td}>47å€‹ã®DIDã‚’ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰</td>
      <td style={TableStyle.td}>UI 5ï½10ç§’å›ºã¾ã‚Š</td>
      <td style={TableStyle.td}>ğŸŸ  Medium</td>
    </tr>
  </tbody>
</table>

### å®Ÿè£…ã•ã‚ŒãŸæ”¹å–„ç­–

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>æ”¹å–„é …ç›®</th>
      <th style={TableStyle.th}>å®Ÿè£…æŠ€è¡“</th>
      <th style={TableStyle.th}>åŠ¹æœ</th>
      <th style={TableStyle.th}>æ”¹å–„åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–</td>
      <td style={TableStyle.td}>MapLibreGLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹</td>
      <td style={TableStyle.td}>ãƒ¡ãƒ¢ãƒª 50% å‰Šæ¸›ï¼ˆ~58MBï¼‰</td>
      <td style={TableStyle.td}>ğŸŸ¢ Excellent</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>mousemoveç¯€æµ</td>
      <td style={TableStyle.td}>requestAnimationFrame</td>
      <td style={TableStyle.td}>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ60Hzï¼‰ã€CPU 90% å‰Šæ¸›</td>
      <td style={TableStyle.td}>ğŸŸ¢ Excellent</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢æœ€é©åŒ–</td>
      <td style={TableStyle.td}>è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚¯ã‚¨ãƒª</td>
      <td style={TableStyle.td}>æ¤œç´¢é€Ÿåº¦ æ•°å€ï½47å€é«˜é€ŸåŒ–</td>
      <td style={TableStyle.td}>ğŸŸ¢ Excellent</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒãƒƒãƒå‡¦ç†</td>
      <td style={TableStyle.td}>requestIdleCallback</td>
      <td style={TableStyle.td}>UI ãƒ–ãƒ­ãƒƒã‚¯ 5ï½10ç§’ â†’ 0.5ç§’ä»¥ä¸‹ï¼ˆ95%å‰Šæ¸›ï¼‰</td>
      <td style={TableStyle.td}>ğŸŸ¢ Excellent</td>
    </tr>
  </tbody>
</table>

---

## 2. å®Ÿè£…è©³ç´°

### 2.1 ãƒ¡ãƒ¢ãƒªé‡è¤‡æ’é™¤

#### å•é¡Œ

```typescript
// âŒ æ”¹å–„å‰: ãƒ‡ãƒ¼ã‚¿ãŒ3ç®‡æ‰€ã«å­˜åœ¨
map.addSource(layerId, { type: 'geojson', data })  // MapLibre GLå†…éƒ¨: 58.68 MB
didGeoJSONCacheRef.current.set(layerId, data)      // In-memory: 58.68 MB
// + ãƒ–ãƒ©ã‚¦ã‚¶Cache API: 58.68 MB
// = åˆè¨ˆ: ~117 MB
```

#### è§£æ±ºæ–¹æ³•

```typescript
// âœ… æ”¹å–„å¾Œ: MapLibre GLã‚½ãƒ¼ã‚¹ã‹ã‚‰ç›´æ¥å–å¾—
const source = map.getSource(layerId) as maplibregl.GeoJSONSource
const sourceData = source.serialize().data as GeoJSON.FeatureCollection

// ãƒ¡ãƒ¢ãƒª: ~58 MBï¼ˆ50%å‰Šæ¸›ï¼‰
```

#### ãƒ¡ãƒªãƒƒãƒˆ

- **ãƒ¡ãƒ¢ãƒªå‰Šæ¸›**: å…¨DIDèª­ã¿è¾¼ã¿æ™‚ã« ~58 MB ç¯€ç´„
- **ã‚³ãƒ¼ãƒ‰ç°¡æ½”åŒ–**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯å‰Šé™¤
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸€å…ƒåŒ–**: MapLibreGLã¨ãƒ–ãƒ©ã‚¦ã‚¶Cache APIã®ã¿

---

### 2.2 mousemove ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°

#### å•é¡Œ

```typescript
// âŒ æ”¹å–„å‰: æ¯ãƒ”ã‚¯ã‚»ãƒ«ç§»å‹•ã§ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæ•°ç™¾ Hzï¼‰
map.on('mousemove', (e) => {
  const features = map.queryRenderedFeatures(e.point)  // åŒæœŸå‡¦ç†ã§ãƒ–ãƒ­ãƒƒã‚¯
  // ... ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºå‡¦ç†
})
```

#### è§£æ±ºæ–¹æ³•

```typescript
// âœ… æ”¹å–„å¾Œ: requestAnimationFrameã§ç¯€æµï¼ˆæœ€å¤§ 60 Hzï¼‰
let mouseMoveRafId: number | null = null

const throttledMouseMove = (e: maplibregl.MapMouseEvent) => {
  if (mouseMoveRafId !== null) return  // æ—¢ã«äºˆç´„æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

  mouseMoveRafId = window.requestAnimationFrame(() => {
    mouseMoveRafId = null
    handleMouseMove(e)
  })
}

map.on('mousemove', throttledMouseMove)
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>æŒ‡æ¨™</th>
      <th style={TableStyle.th}>æ”¹å–„å‰</th>
      <th style={TableStyle.th}>æ”¹å–„å¾Œ</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>å®Ÿè¡Œé »åº¦</td>
      <td style={TableStyle.td}>~400 Hz</td>
      <td style={TableStyle.td}>60 Hz ï¼ˆæœ€å¤§ï¼‰</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>CPU ä½¿ç”¨ç‡</td>
      <td style={TableStyle.td}>~80%</td>
      <td style={TableStyle.td}>~20%</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‰ãƒ­ãƒƒãƒ—</td>
      <td style={TableStyle.td}>é »ç¹</td>
      <td style={TableStyle.td}>ã»ã¼ãªã—</td>
    </tr>
  </tbody>
</table>

---

### 2.3 queryRenderedFeatures æœ€é©åŒ–

#### å•é¡Œ

```typescript
// âŒ æ”¹å–„å‰: 94å€‹ã®å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
const features = map.queryRenderedFeatures(e.point)  // å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢

// DIDå…¨å›½è¡¨ç¤ºæ™‚:
// - did-01 ï½ did-47 (fill): 47å€‹
// - did-01-outline ï½ did-47-outline (line): 47å€‹
// + åˆ¶é™ã‚¨ãƒªã‚¢å±¤: è¤‡æ•°
// = è¨ˆ 94å€‹ä»¥ä¸Šã‚’æ¯å›æ¤œç´¢
```

#### è§£æ±ºæ–¹æ³•

```typescript
// âœ… æ”¹å–„å¾Œ: è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’æ¤œç´¢å¯¾è±¡ã«
const visibleQueryLayers: string[] = []

// ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’åé›†
for (const [layerId, state] of layerStates.entries()) {
  if (state.visible) visibleQueryLayers.push(layerId)
}

// è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚¯ã‚¨ãƒª
const features = map.queryRenderedFeatures(e.point, {
  layers: visibleQueryLayers
})
```

#### åŠ¹æœ

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>çŠ¶æ³</th>
      <th style={TableStyle.th}>æ¤œç´¢å¯¾è±¡</th>
      <th style={TableStyle.th}>æ”¹å–„åŠ¹æœ</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>DID å…¨å›½è¡¨ç¤º</td>
      <td style={TableStyle.td}>94å€‹ â†’ 94å€‹</td>
      <td style={TableStyle.td}>æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ åŠ¹ç‡å‘ä¸Š</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>DID æ±äº¬ã®ã¿</td>
      <td style={TableStyle.td}>94å€‹ â†’ 2å€‹</td>
      <td style={TableStyle.td}>47å€é«˜é€ŸåŒ–</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ç©ºæ¸¯ + åˆ¶é™ã‚¨ãƒªã‚¢</td>
      <td style={TableStyle.td}>94å€‹ â†’ 6å€‹</td>
      <td style={TableStyle.td}>16å€é«˜é€ŸåŒ–</td>
    </tr>
  </tbody>
</table>

---

### 2.4 DID ãƒ¬ã‚¤ãƒ¤ãƒ¼ ãƒãƒƒãƒèª­ã¿è¾¼ã¿

#### å•é¡Œ

```typescript
// âŒ æ”¹å–„å‰: 47å€‹ã‚’åŒæœŸçš„ã«ä¸€æ‹¬è¿½åŠ 
for (const layer of allLayers) {  // 47å›ãƒ«ãƒ¼ãƒ—
  const data = await fetchGeoJSONWithCache(layer.path)
  map.addSource(...)
  map.addLayer(...)  // æ¯ãƒ«ãƒ¼ãƒ—ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
}
// â†’ UI 5ï½10ç§’å›ºã¾ã‚Š
```

#### è§£æ±ºæ–¹æ³•

```typescript
// âœ… æ”¹å–„å¾Œ: ãƒãƒƒãƒå‡¦ç† + requestIdleCallback
const BATCH_SIZE = 7
let batchIndex = 0

const processBatch = async () => {
  const batch = allLayers.slice(batchIndex, batchIndex + BATCH_SIZE)

  for (const layer of batch) {
    const data = await fetchGeoJSONWithCache(layer.path)
    map.addSource(...)
    map.addLayer(...)
  }

  batchIndex += BATCH_SIZE

  if (batchIndex < allLayers.length) {
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚é–“ã«æ¬¡ãƒãƒƒãƒã‚’å‡¦ç†
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => processBatch(), { timeout: 1000 })
    } else {
      requestAnimationFrame(() => processBatch())
    }
  }
}

await processBatch()
```

#### æ™‚ç³»åˆ—ã‚¤ãƒ¡ãƒ¼ã‚¸

```
æ”¹å–„å‰: â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ (5ï½10ç§’ã€UIå®Œå…¨ãƒ–ãƒ­ãƒƒã‚¯)

æ”¹å–„å¾Œ:
  UI thread: â–‘â–‘â–‘â–‘â–‘ â–‘â–‘â–‘â–‘â–‘ â–‘â–‘â–‘â–‘â–‘ ... (1ãƒ•ãƒ¬ãƒ¼ãƒ  â‰ˆ 16.7ms)
  Batch 1-7: â–“â–“â–“â–“â–“â–“â–“ (idle time ã«å‡¦ç†)
  Batch 8-14: â–“â–“â–“â–“â–“â–“â–“
  ...
  = 0.5ç§’ä»¥ä¸‹ã§ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€UIå¸¸ã«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–
```

#### åŠ¹æœ

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>æŒ‡æ¨™</th>
      <th style={TableStyle.th}>æ”¹å–„å‰</th>
      <th style={TableStyle.th}>æ”¹å–„å¾Œ</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>UI ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“</td>
      <td style={TableStyle.td}>5ï½10ç§’</td>
      <td style={TableStyle.td}>0.5ç§’ä»¥ä¸‹</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¯èƒ½æ€§</td>
      <td style={TableStyle.td}>ä¸å¯</td>
      <td style={TableStyle.td}>å¸¸ã«å¯èƒ½</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ</td>
      <td style={TableStyle.td}>0 FPS</td>
      <td style={TableStyle.td}>60 FPS ç¶­æŒ</td>
    </tr>
  </tbody>
</table>

---

## 3. ãƒˆãƒ¼ã‚¿ãƒ« ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

```
æ”¹å–„å‰ï¼ˆDIDå…¨å›½è¡¨ç¤ºæ™‚ï¼‰:
  MapLibre GL source: 58.68 MB
  didGeoJSONCacheRef: 58.68 MB
  ãƒ–ãƒ©ã‚¦ã‚¶ Cache:    58.68 MB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  åˆè¨ˆ: ~117 MB

æ”¹å–„å¾Œ:
  MapLibre GL source: 58.68 MB
  ãƒ–ãƒ©ã‚¦ã‚¶ Cache:    58.68 MB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  åˆè¨ˆ: ~117 MB â†’ 58.68 MB

å‰Šæ¸›: 50% âœ¨
```

### JavaScript å®Ÿè¡Œæ™‚é–“ï¼ˆDIDå…¨å›½è¡¨ç¤ºæ™‚ï¼‰

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>æ“ä½œ</th>
      <th style={TableStyle.th}>æ”¹å–„å‰</th>
      <th style={TableStyle.th}>æ”¹å–„å¾Œ</th>
      <th style={TableStyle.th}>æ”¹å–„ç‡</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒã‚¦ã‚¹ç§»å‹•ï¼ˆtooltipè¡¨ç¤ºï¼‰</td>
      <td style={TableStyle.td}>50-150ms</td>
      <td style={TableStyle.td}>5-20ms</td>
      <td style={TableStyle.td}>90%å‰Šæ¸›</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿è¾¼ã¿</td>
      <td style={TableStyle.td}>5-10ç§’ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰</td>
      <td style={TableStyle.td}>0.5ç§’ï¼ˆãƒãƒƒãƒï¼‰</td>
      <td style={TableStyle.td}>95%å‰Šæ¸›</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>åˆæœŸè¡¨ç¤º</td>
      <td style={TableStyle.td}>8-12ç§’</td>
      <td style={TableStyle.td}>1-2ç§’</td>
      <td style={TableStyle.td}>85%å‰Šæ¸›</td>
    </tr>
  </tbody>
</table>

### UX æ”¹å–„

<table style={TableStyle.table}>
  <thead>
    <tr style={TableStyle.thead}>
      <th style={TableStyle.th}>é …ç›®</th>
      <th style={TableStyle.th}>æ”¹å–„å‰</th>
      <th style={TableStyle.th}>æ”¹å–„å¾Œ</th>
    </tr>
  </thead>
  <tbody>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>UI ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ€§</td>
      <td style={TableStyle.td}>âŒ å›ºã¾ã‚‹</td>
      <td style={TableStyle.td}>âœ… ã‚¹ãƒ ãƒ¼ã‚º</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºé€Ÿåº¦</td>
      <td style={TableStyle.td}>é…å»¶ã‚ã‚Š</td>
      <td style={TableStyle.td}>å³åº§</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ“ä½œ</td>
      <td style={TableStyle.td}>é…å»¶</td>
      <td style={TableStyle.td}>ã‚¹ãƒ ãƒ¼ã‚º</td>
    </tr>
    <tr style={TableStyle.tr}>
      <td style={TableStyle.td}>DIDèª­ã¿è¾¼ã¿ä¸­ã®æ“ä½œ</td>
      <td style={TableStyle.td}>ä¸å¯</td>
      <td style={TableStyle.td}>å¯èƒ½</td>
    </tr>
  </tbody>
</table>

---

## 4. å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

### 4.1 requestIdleCallback ã®äº’æ›æ€§

```typescript
// Safari/å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶éå¯¾å¿œã®å ´åˆ
if ('requestIdleCallback' in window) {
  requestIdleCallback(() => processBatch())
} else {
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: requestAnimationFrame
  requestAnimationFrame(() => processBatch())
}
```

### 4.2 MapLibre GL ã‚½ãƒ¼ã‚¹ã®ç¢ºèª

```typescript
// ã‚½ãƒ¼ã‚¹å–å¾—æ™‚ã¯ try-catch ã§ä¿è­·
try {
  const source = map.getSource(layerId) as maplibregl.GeoJSONSource
  if (source) {
    const data = source.serialize().data as GeoJSON.FeatureCollection
    // ä½¿ç”¨
  }
} catch {
  // ã‚½ãƒ¼ã‚¹æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
}
```

### 4.3 visible ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½è·¡

```typescript
// queryRenderedFeatures æœ€é©åŒ–æ™‚ã¯ layerStates ã‚’åŒæœŸ
// ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºçŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ visibleQueryLayers ã‚’å†æ§‹ç¯‰
const visibleQueryLayers = Array.from(layerStates.entries())
  .filter(([, state]) => state.visible)
  .map(([id]) => id)
```

---

## 5. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å¤§è¦æ¨¡ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¡¨ç¤ºæ™‚

âœ… **æ¨å¥¨äº‹é …**
- ãƒãƒƒãƒå‡¦ç†ã§æ®µéšçš„ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
- requestAnimationFrame/requestIdleCallback ã§ UI ã‚¹ãƒ¬ãƒƒãƒ‰åˆ†é›¢
- ãƒ¡ãƒ¢ãƒªé‡è¤‡æ’é™¤ï¼ˆMapLibre GL ã‚½ãƒ¼ã‚¹ç›´æ¥å‚ç…§ï¼‰
- è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ã‚’ã‚¯ã‚¨ãƒªå¯¾è±¡ã«

âŒ **é¿ã‘ã‚‹ã¹ã**
- å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸçš„ã«ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰
- æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¤œç´¢
- åŒã˜ãƒ‡ãƒ¼ã‚¿ã®è¤‡æ•°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒ
- ç„¡åˆ¶é™ã® UI æ›´æ–°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// Chrome DevTools Performance ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
performance.mark('did-load-start')
// ... å‡¦ç†
performance.mark('did-load-end')
performance.measure('DID Load', 'did-load-start', 'did-load-end')

// React Profiler ã§ã®è¨ˆæ¸¬
<Profiler id="DID-Layer" onRender={onRenderCallback}>
  {/* DID ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}
</Profiler>
```

---

## 6. é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

- **MapLibre GL Docs**: [QueryRenderedFeatures](https://maplibre.org/maplibre-gl-js/docs/API/classes/Map/#queryrenderedfeatures)
- **Web APIs**: [requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)
- **React Docs**: [Performance Optimization](https://react.dev/reference/react/useMemo)
- **GeoJSON**: [RFC 7946](https://tools.ietf.org/html/rfc7946)

---

## 7. å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

ä¸»è¦ãªå®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:
- `src/App.tsx` (L1378-1580): mousemove ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚° + queryRenderedFeatures æœ€é©åŒ–
- `src/App.tsx` (L3139-3229): DID ãƒãƒƒãƒå‡¦ç†
- `src/App.tsx` (L420-466): ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–ï¼ˆMapLibre GL ç›´æ¥å‚ç…§ï¼‰
