{/*GSIArch.mdx*/}
import { Meta } from '@storybook/blocks'

<Meta title="Learning/07_GSIアーキテクチャ" />

# GSIアーキテクチャと分散システム

国土地理院地図システムを大規模分散地理情報システム (Distributed GIS) の一例として捉え、そのスケーラビリティとパフォーマンス特性を分析します。

## 1. ズームレベルと空間分解能の数学

解像度（1ピクセルあたりの実距離）は、赤道において最大となり、緯度が高くなるにつれて小さくなります。Web Mercator における解像度 `R_ground` (meter/pixel) は以下の式で求められます（タイルサイズ 256px の場合）。

```
R_ground = (Earth Circumference × cos(latitude)) / (2^zoom × 256)
```

地球の円周は約 40,075,017m です。

### 計算例（赤道付近、latitude = 0）

- **Z=0**: 解像度 156,543 m/px（国全体）
- **Z=10**: 解像度 152.8 m/px（都市全体）
- **Z=18**: 解像度 0.597 m/px（車一台分）

## 2. クライアント-サーバー分散モデル

本システムは、**Fat Client** モデルを採用しています。

- **サーバー (GSI)**: 静的なアセット（タイル画像、GeoJSON）の配信に特化。計算資源を消費せず、CDNによるキャッシュ効率が極大化されています。
- **クライアント (Browser)**: レンダリング、スタイリング、フィルタリング、空間解析などの計算負荷の高い処理を担当。

### 非同期データフェッチと並行性

タイルの取得は大量の並列HTTPリクエストとして発生します。ブラウザの同時接続数制限（通常6-8）を考慮し、優先度付きキューイングやビューポート外のリクエストキャンセル（AbortController）が重要になります。

```typescript
// AbortController を用いたリクエスト管理の概念モデル
class TileFetcher {
  private controllers = new Map<string, AbortController>();

  loadTile(url: string) {
    if (this.controllers.has(url)) {
      this.controllers.get(url).abort(); // 重複/不要リクエストのキャンセル
    }
    
    const controller = new AbortController();
    this.controllers.set(url, controller);

    return fetch(url, { signal: controller.signal })
      .finally(() => this.controllers.delete(url));
  }
}
```

## 3. Web Mercator (EPSG:3857) の幾何学的特性

### 等角写像 (Conformal Projection) と歪み

Web Mercatorは角度を保存しますが、面積は保存しません。高緯度ほど面積が拡大されます。

- **緯度 0度**: 拡大率 1.0、面積比 1倍
- **緯度 60度**: 拡大率 2.0、面積比 4倍
- **緯度 85度**: 拡大率 約11.5、面積比 100倍以上

北海道（北緯43度）と沖縄（北緯26度）では、同じズームレベルでも縮尺（画面上の1cmが表す実距離）が異なることに注意が必要です。

## 4. GSI タイルサービス仕様一覧

**標準地図**

- URL: `std/{z}/{x}/{y}.png`
- 形式: Raster (PNG)
- 特徴: 道路、建物、等高線を含む基本図。注記が焼付けられているため動的なスタイル変更不可

**淡色地図**

- URL: `pale/{z}/{x}/{y}.png`
- 形式: Raster (PNG)
- 特徴: データの視認性を高めるため、彩度を落とした背景地図

**航空写真**

- URL: `seamlessphoto/...`
- 形式: Raster (JPEG)
- 特徴: 複数の時期・ソースの写真を色調補正して接合したモザイク画像

**Kokuarea**

- URL: `kokuarea/{z}/{x}/{y}.geojson`
- 形式: Vector (GeoJSON)
- 特徴: 航空法制限表面。クライアント側でのクリック判定やスタイリングが可能

## 5. 法的・技術的帰属要件

```html
<!-- 地理院タイル利用規約に基づく必須の帰属表示 -->
<a href="https://maps.gsi.go.jp/development/ichiran.html" rel="noreferrer noopener">
  国土地理院
</a>
```

これは単なるデザイン上の要素ではなく、**著作権法** および **測量法** に基づくライセンス要件です。
