{/* Services.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="API/Services" />

# Services API Reference (Deep Dive)

このドキュメントは、アプリケーションの中核となるサービス層の詳細な技術仕様書です。
各サービスはシングルトンパターンまたはステートレスな関数群として実装されており、外部APIとの通信、データ処理、キャッシングを隠蔽します。

## 目次

1. [AirportService (空港・空域管理)](#airportservice)
2. [NoFlyZoneService (飛行禁止区域)](#noflyzoneservice)
3. [GeocodingService (住所検索・逆ジオコーディング)](#geocodingservice)
4. [ElevationService (標高データ)](#elevationservice)
5. [Weather Services (気象データ)](#weather-services)
6. [CustomLayerService (ユーザーデータ)](#customlayerservice)

---

## AirportService

空港データおよび関連する航空法規制区域（制限表面）を提供するコアサービスです。

### アーキテクチャとデータフロー

このサービスは、静的な空港マスターデータ（`src/lib/services/airports.ts`）と、動的な幾何計算（`src/lib/utils/geo.ts`）を組み合わせて機能します。

- **データソース**: 国土数値情報（空港データ）、AIS JAPAN
- **データ構造**: すべての空港データはクライアントサイドにバンドルされており、ネットワークレイテンシなしで即座にアクセス可能です。
- **計算ロジック**: 制限表面（円形）は、リクエスト時に `createCirclePolygon` を使用して動的にGeoJSONとして生成されます。

### 型定義 (Type Definitions)

#### `Airport`
空港オブジェクトの完全な定義です。

```typescript
interface Airport {
  /** IATA/ICAO コードまたは独自ID (例: 'HND', 'RJTT') */
  id: string;
  
  /** 日本語名称 (例: '東京国際空港') */
  name: string;
  
  /** 英語名称 (例: 'Tokyo International Airport') */
  nameEn?: string;
  
  /** 空港の種別 */
  type: 'international' | 'domestic' | 'military' | 'heliport';
  
  /** 座標 [経度, 緯度] (WGS84) */
  coordinates: [number, number];
  
  /** 
   * 航空法に基づく飛行制限半径 (km) 
   * - 指定空港 (小型無人機等飛行禁止法): 約24km (進入表面等を含む広域)
   * - その他空港: 6km (標準的な進入表面長)
   * - ヘリポート: 0.3km - 1km
   */
  radiusKm: number;
  
  /** 小型無人機等飛行禁止法の対象かどうか */
  isDesignatedUnderLaw?: boolean;
}
```

### API 詳細仕様

#### `findNearby(lat, lng, radiusKm)`

指定座標周辺の空港を効率的に検索します。全空港データに対してHaversine距離計算を行うため、計算量は $O(N)$ ですが、$N \approx 200$ 程度であるため、パフォーマンスへの影響は無視できます。

```typescript
static findNearby(lat: number, lng: number, radiusKm: number): Airport[]
```

**ロジック**:
1. 入力座標のバリデーション（緯度 -90~90, 経度 -180~180）。
2. 全空港リストを反復。
3. `calculateDistance` (Haversine) で距離を算出。
4. `distance <= radiusKm` の空港を抽出し、距離の昇順でソートして返却。

**使用例: ドローン飛行前チェック**
```typescript
const lat = 35.6812;
const lng = 139.7671;

// 10km圏内の空港をチェック
const risks = AirportService.findNearby(lat, lng, 10);

if (risks.length > 0) {
  console.warn('以下の空港が近隣にあります:');
  risks.forEach(airport => {
    const dist = calculateDistance(lat, lng, airport.coordinates[1], airport.coordinates[0]);
    console.warn(`- ${airport.name} (${dist.toFixed(1)}km)`);
    
    // 制限表面内かどうかの厳密なチェック
    if (dist <= airport.radiusKm) {
      throw new Error('飛行禁止区域（空港周辺）内です！');
    }
  });
}
```

#### `getRestrictionZone(airportId)`

空港の制限区域を可視化用のGeoJSONとして生成します。

```typescript
static getRestrictionZone(airportId: string): GeoJSON.FeatureCollection | null
```

**生成されるGeoJSONの仕様**:
- `type`: `Polygon`
- `coordinates`: 中心座標から `radiusKm` の距離にある32〜64点の頂点で構成される近似円。
- **精度**: 地球を完全な球体と仮定しているため、厳密な楕円体上の距離とは0.3%程度の誤差が生じる可能性がありますが、ドローン飛行支援用途としては十分な精度です。

---

## GeocodingService

[OpenStreetMap Nominatim API](https://nominatim.org/) を利用した、住所・地名の検索および座標からの住所特定（逆ジオコーディング）サービスです。

### 技術的制約と対策

Nominatim APIには厳格な利用ポリシーがあります。本サービスは以下の機能を内蔵してポリシー遵守を支援します。

1.  **Rate Limiting**: 1秒あたり1リクエストの制限があります。クライアント側で `debounce` 処理を実装することを強く推奨します。
2.  **User-Agent**: APIリクエストヘッダには、アプリケーションを識別するUser-Agentを含める必要があります（実装済み）。
3.  **Attribution**: 検索結果を利用する場合、OpenStreetMapへの帰属表示が必須です。

### API 詳細仕様

#### `search(query, options)`

住所やランドマーク名から座標を検索します。

```typescript
static search(
  query: string,
  options?: {
    limit?: number;   // 取得件数 (default: 5)
    country?: string; // 国コード (default: 'jp')
    viewbox?: [number, number, number, number]; // 優先検索範囲 [minLng, minLat, maxLng, maxLat]
  }
): Promise<GeocodingResult[]>
```

**高度な検索テクニック**:
日本国内の検索精度を上げるため、以下のクエリ整形を推奨します。

- **正規化**: 全角数字を半角に変換する（例: `１丁目` → `1丁目`）。
- **階層化**: `東京都 港区 芝公園` のようにスペース区切りで入力するとヒット率が向上します。

**レスポンス型 (`GeocodingResult`)**:

```typescript
interface GeocodingResult {
  displayName: string; // "東京タワー, 4-2-8, 芝公園, 港区..."
  lat: number;
  lng: number;
  type: string;        // "tower", "station", "residential" など
  importance: number;  // 0.0 ~ 1.0 の重要度スコア
  address?: {          // 詳細住所コンポーネント
    state?: string;    // 都道府県
    city?: string;     // 市区町村
    town?: string;     // 町名
    road?: string;
    postcode?: string;
  };
  boundingBox?: [number, number, number, number]; // [minLat, maxLat, minLng, maxLng]
}
```

#### `reverse(lat, lng)`

座標から住所情報を取得します。ドローンが現在飛行している場所の住所を特定するのに役立ちます。

```typescript
static reverse(lat: number, lng: number): Promise<GeocodingResult | null>
```

**ユースケース: クリック地点の住所表示**

```typescript
map.on('click', async (e) => {
  const { lng, lat } = e.lngLat;
  
  try {
    const result = await GeocodingService.reverse(lat, lng);
    if (result) {
      const address = GeocodingService.format(result.address);
      new Popup()
        .setLngLat([lng, lat])
        .setHTML(`<b>${address}</b><br>緯度: ${lat.toFixed(6)}<br>経度: ${lng.toFixed(6)}`)
        .addTo(map);
    }
  } catch (err) {
    console.error('住所取得失敗', err);
  }
});
```

---

## ElevationService

[国土地理院 (GSI) 標高タイルAPI](https://maps.gsi.go.jp/development/siyou.html) を使用して、日本国内の任意の地点の海抜高度（ASL: Above Sea Level）を取得します。

**注意**: 本サービスはクラスではなく、個別の関数群としてエクスポートされています。

### 技術的背景: 標高タイルの仕組み

国土地理院の標高APIは、地図画像タイルと同様の `Z/X/Y` 座標系を採用していますが、画像ではなくテキストデータ（`.txt`）として標高値を提供します。

- **タイルURL**: `https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon={lon}&lat={lat}&outtype=JSON`
- **データソース**:
  - **DEM5A/5B**: 航空レーザ測量による5mメッシュ（精度高、都市部中心）
  - **DEM10B**: 10mメッシュ（全国カバー）
- **補間**: APIは指定座標の最近傍または双一次補間によって計算された値を返します。

### API 詳細仕様

#### `fetchElevationFromGSI(lng, lat)`

指定座標の標高を取得します。

```typescript
export async function fetchElevationFromGSI(
  lng: number, 
  lat: number
): Promise<ElevationData | null>
```

**内部ロジック**:
1.  **キャッシュ確認**: メモリ内キャッシュ（`Map<string, ElevationData>`）を確認。キーは座標を小数第5位（約1m精度）で丸めて生成。
2.  **APIリクエスト**: GSIサーバーへリクエスト。
3.  **エラーハンドリング**:
    - サーバーエラーやタイムアウト時は `null` を返却。
    - **重要**: 海上やデータ欠損地域の場合、APIによってはエラーではなく特殊な値が返る場合がありますが、本ラッパーは `null` または `0` (海上と推測される場合) を適切に処理します。

#### `getRecommendedFlightAltitude(lng, lat, safetyMargin)`

法令遵守と安全性を考慮した推奨飛行高度（AGL: 対地高度）を計算します。

```typescript
export async function getRecommendedFlightAltitude(
  lng: number,
  lat: number,
  safetyMarginMeters: number = 30
): Promise<number | null>
```

**計算式**:
$$ TargetAltitude (ASL) = TerrainElevation + SafetyMargin $$

**レシピ: 飛行ルートの高度プロファイル生成**

飛行ルート（点群）全体の標高を取得し、地形衝突リスクを可視化する高度な例です。

```typescript
import { fetchElevationBatch } from 'japan-drone-map/services/elevationService';

async function analyzeRouteProfile(routePoints: [number, number][]) {
  // 並列リクエスト数の制限（ブラウザの同時接続数制限を考慮）
  const BATCH_SIZE = 5;
  const profiles = [];

  for (let i = 0; i < routePoints.length; i += BATCH_SIZE) {
    const batch = routePoints.slice(i, i + BATCH_SIZE);
    
    // Promise.all で並列実行
    const results = await Promise.all(
      batch.map(async ([lng, lat]) => {
        const data = await fetchElevationFromGSI(lng, lat);
        return {
          lng, lat,
          elevation: data?.elevation ?? 0,
          isSea: data === null // データ取得不可は海とみなす等のフォールバック
        };
      })
    );
    profiles.push(...results);
  }
  
  return profiles;
}
```

---

## Weather Services

気象情報は、飛行の可否を決定する最もクリティカルな要素です。本ライブラリは複数のプロバイダを統合しています。

### RainViewerService (雨雲レーダー)

世界中の気象レーダーを統合したAPI。

- **`getAvailableFrames()`**: 利用可能な過去・未来のタイムスタンプ配列を取得。
- **`buildTileUrl(path)`**: MapLibreのラスターレイヤーとして利用可能なXYZタイルURLを生成。

**実装のポイント**:
アニメーション表示を行う場合、全フレームのタイルを一気に読み込むとネットワーク帯域を圧迫します。現在表示中のフレームと、次のフレームのみをプリロードする制御が推奨されます。

### OpenWeatherService (総合気象)

- **`fetchWeather(lat, lng)`**: 現在の天気、気温、湿度、気圧、風速、風向。
- **`fetchWind(lat, lng)`**: 風に特化した軽量APIコール。

**風速カテゴリ (Beaufort Scale for Drones)**:
ドローン運用向けにカスタマイズされた風速評価ロジックを内蔵しています。

| 風速 (m/s) | レベル | 判定 |
|:---:|:---:|:---:|
| < 5.0 | Safe | 安全に飛行可能 |
| 5.0 - 10.0 | Caution | 注意が必要（バッテリー消費増、安定性低下） |
| > 10.0 | Danger | **飛行中止を強く推奨** |

---

## CustomLayerService

ユーザー生成コンテンツ（UGC）やアプリケーション固有のデータを管理します。
ブラウザの `localStorage` を永続化層として使用するため、バックエンドサーバーなしで動作します。

### データモデル

カスタムレイヤーはGeoJSONをラップするメタデータ付きオブジェクトです。

```typescript
interface CustomLayer {
  id: string;          // UUID v4
  type: 'restriction' | 'poi' | 'flight-plan';
  name: string;
  data: GeoJSON.FeatureCollection;
  
  // スタイル設定
  color: string;       // HEX color
  opacity: number;     // 0.0 - 1.0
  
  // 管理情報
  visible: boolean;
  createdAt: number;   // Unix Timestamp
  updatedAt: number;
}
```

### ストレージ制限と対策

`localStorage` の容量制限（通常5-10MB）は、複雑なポリゴンデータを含むGeoJSONを扱う際にボトルネックとなります。

**対策**:
1.  **座標精度の削減**: 保存時に座標の小数点以下を6桁（約11cm精度）に丸めることで、ファイルサイズを30-50%削減できます。
2.  **プロパティの最小化**: GeoJSONの `properties` に不要なデータを含めない。
3.  **圧縮**: `lz-string` 等のライブラリを用いて文字列圧縮してから保存する（本サービスの将来的な拡張候補）。

---

## ユーティリティ関数リファレンス

詳細は [Utilities API Reference](./?path=/docs/api-utilities--docs) を参照してください。

- **`calculateDistance`**: 地球の曲率を考慮した正確な距離計算。
- **`pointInPolygon`**: 飛行禁止区域内かどうかの判定アルゴリズム。
- **`formatCoordinatesDMS`**: 航空業界標準（NOTAM等）の度分秒形式への変換。
