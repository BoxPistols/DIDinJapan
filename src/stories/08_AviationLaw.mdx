{/* AviationLaw.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="Learning/08_航空法対策" />

# 航空法コンプライアンスのアルゴリズム

ドローン（無人航空機）飛行支援システムにおける法令遵守（Compliance Engineering）機能の技術的実装について解説します。

## 1. 地理フェンス (Geofencing) アルゴリズム

「飛行禁止空域」の判定は、計算幾何学における **Point-in-Polygon (PIP)** 問題に帰着します。

### Ray Casting Algorithm (光線投影法)

任意の点 P から半直線を伸ばし、ポリゴンの境界線と交差する回数を数えます。
- **奇数回**: 内部
- **偶数回**: 外部

```typescript
// O(N) Complexity Implementation
function isPointInPolygon(point: number[], vs: number[][]) {
  const x = point[0], y = point[1];
  let inside = false;
  for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
    const xi = vs[i][0], yi = vs[i][1];
    const xj = vs[j][0], yj = vs[j][1];
    
    // Ray intersection test
    const intersect = ((yi > y) !== (yj > y))
        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}
```

## 2. 測地線距離計算 (Geodesic Distance)

地球表面上の2点間の最短距離は、大円距離 (Great-circle distance) として計算されます。

### Haversine Formula (半正矢関数)

```
a = sin²(Δφ/2) + cos(φ1) × cos(φ2) × sin²(Δλ/2)
c = 2 × atan2(√a, √(1-a))
d = R × c
```

ここで、φ は緯度 (radian)、λ は経度 (radian)、R は地球半径です。

```typescript
function calculateHaversineDistance(p1: [number, number], p2: [number, number]): number {
  const R = 6371e3; // meters
  const phi1 = p1[1] * Math.PI / 180;
  const phi2 = p2[1] * Math.PI / 180;
  const deltaPhi = (p2[1] - p1[1]) * Math.PI / 180;
  const deltaLambda = (p2[0] - p1[0]) * Math.PI / 180;

  const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}
```

**※注意**: Haversine式は地球を真球と仮定します。より高精度な計算が必要な場合（空港の敷地境界誤差数cmレベルなど）は、回転楕円体を考慮した **Vincenty法** を使用すべきですが、リアルタイム判定には計算コストが高いため、用途に応じて使い分けます。

## 3. 高さ制限と3次元空間解析

空港周辺では、滑走路からの距離に応じて高度制限（進入表面）が変化します。これは幾何学的には「滑走路を基準線とした斜平面との距離計算」となります。

```
H_limit = tan(θ) × D_runway + H_runway
```

勾配 θ は 1/50 (2%) 等と法律で定義されています。

## 4. コンプライアンス・エンジニアリング

システムは「ユーザーが故意に違反しようとしない限り、自然に法令を遵守できる」設計（**Poka-yoke**）を目指します。

1.  **Fail-Safe**: データ取得失敗時は「飛行不可」と判定（安全側に倒す）。
2.  **Audit Trail**: 飛行計画作成時の使用データバージョンと判定ロジックバージョンを記録し、事後検証可能性を担保。
