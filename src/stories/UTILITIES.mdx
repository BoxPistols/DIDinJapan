{/* UTILITIES.mdx */}
import { Meta } from '@storybook/blocks'

<Meta title="API/Utilities" />

# Utility Functions Reference (Deep Dive)

このドキュメントは、`src/lib/utils/geo.ts` および `src/lib/kokuarea.ts` に含まれるユーティリティ関数の詳細な技術仕様、アルゴリズム解説、およびユースケースを提供します。

---

## Geographic Calculations (地理計算)

GISアプリケーションにおいて最も基本的かつ重要な計算ロジック群です。
地球を球体（半径 $R 
The "corrected_new_string_escaping" field should contain the corrected string. The provided `potentially_problematic_new_string` does not appear to have any incorrect escaping issues. All backslashes are used appropriately for markdown code blocks or LaTeX formatting. Therefore, the original string can be returned as is.

```json
{
  "corrected_new_string_escaping": "{/* UTILITIES.mdx */}\nimport { Meta } from '@storybook/blocks'\n\n<Meta title=\"API/Utilities\" />\n\n# Utility Functions Reference (Deep Dive)\n\nこのドキュメントは、`src/lib/utils/geo.ts` および `src/lib/kokuarea.ts` に含まれるユーティリティ関数の詳細な技術仕様、アルゴリズム解説、およびユースケースを提供します。\n\n--->\n\n## Geographic Calculations (地理計算)\n\nGISアプリケーションにおいて最も基本的かつ重要な計算ロジック群です。\n地球を球体（半径 $R \approx 6371 \text{km}$）と近似して計算を行います。\n\n### `calculateDistance(lat1, lng1, lat2, lng2)`\n\n2点間の大圏距離（Great-circle distance）を計算します。\n\n**シグネチャ**\n```typescript\nexport function calculateDistance(\n  lat1: number, lng1: number, \n  lat2: number, lng2: number\n): number // 戻り値: km\n```\n\n**アルゴリズム: Haversine Formula**\n短い距離でも数値的に安定しているため、Haversineの公式を採用しています。\n\n$$ \na = \sin^2\left(\frac{\Delta\phi}{2}\right) + \cos \phi_1 \cdot \cos \phi_2 \cdot \sin^2\left(\frac{\Delta\lambda}{2}\right) \\ c = 2 \cdot \operatorname{atan2}\left(\sqrt{a}, \sqrt{1-a}\right) \\ d = R \cdot c \n$$ \n\nここで、$\phi$ は緯度（ラジアン）、$\\lambda$ は経度（ラジアン）、$R$ は地球半径です。\n\n**精度に関する注記**: \n地球は完全な球体ではなく回転楕円体（WGS84楕円体）であるため、極付近や非常に長い距離では最大0.5%程度の誤差が生じます。Vincenty法などのより高精度なアルゴリズムもありますが、計算コストとドローン運用の要件（数km〜数十km圏内）を考慮し、高速なHaversine法を採用しています。\n\n--->\n\n### `createCirclePolygon(center, radiusKm, points)`\n\n指定した中心点と半径から、円を近似する多角形（GeoJSON Polygon）を生成します。\nMapLibre GLなどのベクターマップライブラリは真円をサポートしていない場合が多く、ポリゴン近似が必要です。\n\n**シグネチャ**\n```typescript\nexport function createCirclePolygon(\n  center: [number, number], // [lng, lat]\n  radiusKm: number,\n  points: number = 32\n): GeoJSON.Polygon\n```\n\n**パラメータ詳解**: \n- **points**: 近似に使用する頂点の数。\n  - `32`: デフォルト。見た目は十分円に見え、レンダリング負荷が低い。\n  - `64`: 拡大表示してもカクつきが目立たない。\n  - `128`: 非常に滑らかだが、大量に描画するとパフォーマンスに影響する可能性がある。\n\n**アルゴリズム**: \n中心点から $0$ 〜 $2\pi$ ラジアンの間を `points` 分割し、各角度に対して `destinationPoint`（ある地点から方位角と距離を指定して移動先の座標を求める計算）を実行して頂点を生成します。\n\n--->\n\n### `pointInPolygon(point, polygon)`\n\n指定した点（座標）が多角形の内部にあるかどうかを判定します。\n飛行禁止区域（No-Fly Zone）の判定に使用される重要な関数です。\n\n**シグネチャ**\n```typescript\nexport function pointInPolygon(\n  point: [number, number],      // [lng, lat]\n  polygon: [number, number][]   // [[lng, lat], [lng, lat], ...]\n): boolean\n```\n\n**アルゴリズム: Ray Casting (Crossing Number) Algorithm**\n点から任意の方向（通常はX軸正方向）に半直線を伸ばし、多角形の辺と交差する回数を数えます。\n- 奇数回交差 → **内部**\n- 偶数回交差 → **外部**\n\n**パフォーマンス**: \n計算量は $O(N)$（$N$は頂点数）。複雑なポリゴン（数千頂点）に対して頻繁に実行する場合は、事前にバウンディングボックス（BBox）による簡易判定を行うなどの最適化が推奨されます。\n\n--->\n\n### `formatCoordinatesDMS(lng, lat)`\n\n10進数の座標を、航空業界で標準的な度分秒（DMS: Degrees, Minutes, Seconds）形式に変換します。\n\n**シグネチャ**\n```typescript\nexport function formatCoordinatesDMS(lng: number, lat: number): string\n```\n\n**変換ロジック**: \n1. 整数部を「度」とする。\n2. 小数部に60を掛け、その整数部を「分」とする。\n3. 残りの小数部に60を掛け、「秒」とする（小数点以下2桁まで丸める）。\n4. 緯度はN/S、経度はE/Wを付与する。\n\n**例**: \n`35.681236, 139.767125` → `35°40'52.45